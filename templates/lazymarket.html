<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <title>Chia sẻ tài liệu & BXH - StudyVault</title>
    <style>
        /* --- Phong cách chung --- */
        :root {
             --primary-blue: #0d6efd; --light-bg: #f8f9fa; --white-bg: #ffffff; --card-border-radius: 0.75rem; --element-border-radius: 0.5rem; --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); --text-dark: #212529; --text-muted: #6c757d; --accent-red: #dc3545; --accent-green: #198754; --accent-info: #0dcaf0; --bs-warning: #ffc107;
             --bs-info-subtle: #cff4fc; /* Thêm màu để highlight */
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--light-bg); color: var(--text-dark); }
        .navbar { background-color: var(--white-bg) !important; box-shadow: var(--card-shadow); }
        .navbar-brand { color: var(--text-dark) !important; font-weight: 600; }
        .navbar-brand i { color: var(--primary-blue); }
        .nav-link { color: #495057 !important; font-weight: 500; }
        .nav-link.active { color: var(--primary-blue) !important; font-weight: 600;}
        .card { border-radius: var(--card-border-radius); border: none; box-shadow: var(--card-shadow); margin-bottom: 1.5rem; background-color: var(--white-bg); border-top: 4px solid var(--primary-blue); }
        .card-header { background-color: transparent; border-bottom: 1px solid #f1f3f5; font-weight: 600; padding: 1rem 1.25rem; color: var(--primary-blue); }
         .card-header i { color: var(--primary-blue) !important; }
        .btn { border-radius: var(--element-border-radius); padding: 0.5rem 1rem; font-weight: 500; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; color: white;}
        .btn-secondary:hover { background-color: #5a6268; border-color: #545b62;}
        .badge { border-radius: 50px; font-weight: 500; padding: 0.35em 0.65em; }
        h1 { margin-bottom: 1.5rem !important; font-weight: 600; color: var(--primary-blue); }
         h1 i { color: var(--primary-blue) !important; }

        /* --- CSS Bảng xếp hạng --- */
        .ranking-item { display: flex; flex-direction: column; align-items: stretch; padding: 0.8rem 0.5rem; /* Giảm padding ngang */ border-bottom: 1px solid #f1f3f5; transition: background-color 0.2s ease; }
        .ranking-item:last-child { border-bottom: none; }
        .ranking-item.highlight { background-color: var(--bs-info-subtle); } /* Class highlight */
        .ranking-main-info { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
        .ranking-info { display: flex; align-items: center; overflow: hidden; flex-grow: 1; margin-right: 1rem; }
        .ranking-rank { font-weight: bold; min-width: 30px; text-align: center; color: #adb5bd; margin-right: 10px; }
        .ranking-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;}
        .ranking-details { font-size: 0.85em; color: var(--text-muted); margin-left: 5px; white-space: nowrap;}
        .ranking-score { font-weight: bold; white-space: nowrap; display: flex; align-items: center; }
        .ranking-score .rating-stars i { color: var(--bs-warning); font-size: 0.9em; }
        .ranking-score .rating-stars i.bi-star { color: #e9ecef; }
        .ranking-score .score-number { text-muted small ms-1 }
        .ranking-criteria { font-size: 0.75em; color: var(--text-muted); padding-left: 40px; display: flex; flex-wrap: wrap; gap: 0 1rem; }
        .criteria-item { white-space: nowrap; }
        .criteria-item .value { font-weight: 500; color: var(--text-dark); }
        .refresh-btn { font-size: 0.8em; padding: 0.2rem 0.5rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 sticky-top">
        <div class="container"> <a class="navbar-brand fw-bold d-flex align-items-center" href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="StudyVault Logo" height="30" class="d-inline-block align-text-top me-2">
            StudyVault
        </a>
         <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav ms-auto"> <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}">Dashboard</a></li> <li class="nav-item"><a class="nav-link" href="{{ url_for('upload_file') }}">Tải lên</a></li> <li class="nav-item"><a class="nav-link" href="{{ url_for('study_timeline') }}">Timeline</a></li>
                     <li class="nav-item"><a class="nav-link active" aria-current="page" href="{{ url_for('lazy_market') }}">Chia sẻ tài liệu & BXH</a></li> </ul> </div> </div>
    </nav>
    <div class="container mt-4">
        <h1 class="mb-4"><i class="bi bi-trophy-fill"></i> Chia sẻ tài liệu & Bảng xếp hạng</h1>
        <div id="rankingContent">
             <div class="row">
                 <div class="col-md-6">
                     <div class="card">
                         <div class="card-header d-flex justify-content-between align-items-center">
                             <span><i class="bi bi-file-earmark-arrow-up-fill me-2"></i>BXH Tài liệu Hot (Top 10)</span>
                             <button id="refreshDocRankingBtn" class="btn btn-sm btn-outline-secondary refresh-btn"><i class="bi bi-arrow-clockwise"></i></button>
                         </div>
                         <div class="card-body" id="documentRankingList">
                             <p class="text-center text-muted p-3">Đang tải bảng xếp hạng...</p>
                         </div>
                     </div>
                 </div>
                 <div class="col-md-6">
                     <div class="card">
                         <div class="card-header d-flex justify-content-between align-items-center">
                             <span><i class="bi bi-person-lines-fill me-2"></i>BXH Thành viên Tích cực (Top 10)</span>
                             <button id="refreshUserRankingBtn" class="btn btn-sm btn-outline-secondary refresh-btn"><i class="bi bi-arrow-clockwise"></i></button>
                         </div>
                         <div class="card-body" id="userRankingList">
                             <p class="text-center text-muted p-3">Đang tải bảng xếp hạng...</p>
                         </div>
                     </div>
                 </div>
                 </div>
        </div>
        <div class="mt-4 mb-5 text-center">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left-circle"></i> Quay lại Dashboard
            </a>
        </div>
        </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // === PHẦN CODE JAVASCRIPT ===

        const realDocsSample = {{ real_docs_sample | tojson | safe }};

        // --- HÀM TẠO SAO ĐÁNH GIÁ ---
        function createRatingStarsHTML(scoreOutOf10) {
            let starsHTML = '';
            let scoreOutOf5 = Math.max(0, Math.min(5, scoreOutOf10 / 2));
            for (let i = 1; i <= 5; i++) {
                if (scoreOutOf5 >= i) { starsHTML += `<i class="bi bi-star-fill"></i>`; }
                else if (scoreOutOf5 >= i - 0.5) { starsHTML += `<i class="bi bi-star-half"></i>`; }
                else { starsHTML += `<i class="bi bi-star"></i>`; }
            }
            return starsHTML;
        }

        // --- Logic cho Bảng xếp hạng ---
        document.addEventListener('DOMContentLoaded', function() {
            const docRankingList = document.getElementById('documentRankingList');
            const userRankingList = document.getElementById('userRankingList');
            const refreshDocBtn = document.getElementById('refreshDocRankingBtn');
            const refreshUserBtn = document.getElementById('refreshUserRankingBtn');
            const fakeDocs = [ {"id":101,"name":"Introduction to Machine Learning.pdf","category":"AI/ML","doc_type":"pdf"},{"id":102,"name":"Kinh tế vi mô nâng cao.docx","category":"Kinh tế học","doc_type":"docx"},{"id":103,"name":"Bài tập giải tích 1.pdf","category":"Toán học","doc_type":"pdf"},{"id":104,"name":"ielts_speaking_tips.txt","category":"Ngoại ngữ","doc_type":"txt"},{"id":105,"name":"https://react.dev/learn","category":"Lập trình Web","doc_type":"link"},{"id":106,"name":"Deep Work - Cal Newport.epub","category":"Kỹ năng mềm","doc_type":"file"},{"id":107,"name":"Đề cương ôn tập Luật Hành chính.pdf","category":"Pháp luật","doc_type":"pdf"},{"id":108,"name":"Algorithms Design Manual.pdf","category":"Lập trình","doc_type":"pdf"},{"id":109,"name":"Macroeconomics Principles.docx","category":"Kinh tế học","doc_type":"docx"},{"id":110,"name":"Linear Algebra Done Right.pdf","category":"Toán học","doc_type":"pdf"} ];
            const fakeUsers = [ "Anh Khoa","Bảo Ngọc","Chí Thành","Diễm Quỳnh","Gia Huy","Hồng Anh","Kim Long","Minh Thư","Nam Khánh","Phương Linh" ];
            function getDocRating() { return (Math.random() * (5 - 3.5) + 3.5).toFixed(1); }
            function getUserScore() { return Math.floor(Math.random() * (2500 - 500 + 1) + 500); }
            function getRandomCriteriaScore() { return Math.floor(Math.random() * (99 - 60 + 1)) + 60; }

            // === BIẾN LƯU TÀI LIỆU ĐƯỢC SHARE ===
            let sharedDocData = null;

            // === KIỂM TRA LOCALSTORAGE KHI TẢI TRANG ===
            try {
                const storedData = localStorage.getItem('sharedDocForRanking');
                if (storedData) {
                    sharedDocData = JSON.parse(storedData);
                    console.log("Found shared doc in localStorage:", sharedDocData);
                    localStorage.removeItem('sharedDocForRanking'); // Xóa đi sau khi đọc
                    console.log("Removed item from localStorage.");
                } else {
                    console.log("No shared doc found in localStorage.");
                }
            } catch(e) {
                console.error("Error reading from localStorage:", e);
                sharedDocData = null;
            }

            // === HÀM TẠO RANKING TÀI LIỆU ===
            function generateDocumentRanking() {
                if (!docRankingList) return;
                console.log("Generating document ranking. Shared data:", sharedDocData);

                let combinedDocs = [...realDocsSample, ...fakeDocs];
                // Loại bỏ doc trùng ID nếu có từ danh sách gốc
                if(sharedDocData && sharedDocData.id) { // Thêm kiểm tra sharedDocData.id
                    combinedDocs = combinedDocs.filter(doc => String(doc.id) !== String(sharedDocData.id)); // So sánh chuỗi để chắc chắn
                }

                let shuffledDocs = combinedDocs.sort(() => 0.5 - Math.random());

                let ratedDocs = shuffledDocs.map(doc => ({
                     id: doc.id, // Đảm bảo ID được giữ lại
                     name: doc.name || "Unknown Document",
                     category: doc.category || "N/A",
                     doc_type: doc.doc_type || "file",
                     rating: getDocRating(),
                     relevance: getRandomCriteriaScore(),
                     learnability: getRandomCriteriaScore(),
                     structure: getRandomCriteriaScore(),
                     practicality: getRandomCriteriaScore(),
                     updatedness: getRandomCriteriaScore(),
                }));

                 // === CHÈN TÀI LIỆU ĐƯỢC SHARE VÀO ĐẦU ===
                 let finalDocList = ratedDocs;
                 if (sharedDocData && sharedDocData.id) { // Thêm kiểm tra sharedDocData.id
                     const sharedDocFullData = {
                         id: sharedDocData.id,
                         name: sharedDocData.name || "Unknown Shared Doc",
                         category: sharedDocData.category || "N/A",
                         doc_type: sharedDocData.doc_type || "file",
                         rating: (Math.random() * (5.0 - 4.5) + 4.5).toFixed(1),
                         relevance: Math.floor(Math.random() * (99 - 90 + 1)) + 90,
                         learnability: Math.floor(Math.random() * (99 - 88 + 1)) + 88,
                         structure: Math.floor(Math.random() * (99 - 85 + 1)) + 85,
                         practicality: Math.floor(Math.random() * (99 - 80 + 1)) + 80,
                         updatedness: Math.floor(Math.random() * (99 - 80 + 1)) + 80,
                         isSharedHighlight: true
                     };
                     finalDocList.unshift(sharedDocFullData);
                     console.log("Prepended shared doc data:", sharedDocFullData);
                 } else {
                     console.log("No valid shared doc data to prepend.");
                 }

                let top10Docs = finalDocList.slice(0, 10);
                console.log("Final top 10 docs for display:", top10Docs);

                if (top10Docs.length === 0) {
                    docRankingList.innerHTML = '<p class="text-center text-muted p-3">Chưa có tài liệu nào trong bảng xếp hạng.</p>';
                    return;
                }

                docRankingList.innerHTML = top10Docs.map((doc, index) => {
                    // Xác định icon
                    let iconClass = 'bi-file-earmark'; const nameLower = doc.name ? doc.name.toLowerCase() : ''; const type = doc.doc_type ? doc.doc_type.toLowerCase() : ''; if (type === 'pdf') { iconClass = 'bi-file-earmark-pdf text-danger'; } else if (type === 'docx') { iconClass = 'bi-file-earmark-word text-primary'; } else if (type === 'txt') { iconClass = 'bi-file-earmark-text text-secondary'; } else if (type === 'link' || nameLower.startsWith('http')) { iconClass = 'bi-link-45deg text-info'; } else if (type === 'googledrive_link') { iconClass = 'bi-google text-info'; } else if (type === 'image') { iconClass = 'bi-image text-success'; } else if (type === 'video') { iconClass = 'bi-film text-warning'; } else if (type === 'epub' || type === 'mobi' || type === 'djvu' || type === 'file') { iconClass = 'bi-book'; }
                    // Tên hiển thị
                    const displayName = doc.name.length > 45 ? doc.name.substring(0, 42) + '...' : doc.name;
                    // Check nếu là tài liệu thật từ user
                    const isRealDoc = realDocsSample.some(realDoc => String(realDoc.id) === String(doc.id)); // So sánh chuỗi
                    const realDocIcon = isRealDoc ? '<i class="bi bi-cloud-check-fill text-success ms-1" title="Tài liệu của bạn"></i>' : '';
                    // Sao đánh giá
                    const starsHTML = createRatingStarsHTML(doc.rating * 2);
                    // Class highlight
                    const highlightClass = doc.isSharedHighlight ? 'highlight' : '';
                    // Icon vừa share
                    const sharedIcon = doc.isSharedHighlight ? '<i class="bi bi-send-check-fill text-primary ms-1" title="Vừa chia sẻ"></i>' : '';
                    // Criteria HTML
                    const criteriaHTML = `
                        <div class="ranking-criteria mt-1">
                            <span class="criteria-item" title="Mức độ liên quan mục tiêu"><i class="bi bi-bullseye"></i> Rel: <span class="value">${doc.relevance}%</span></span>
                            <span class="criteria-item" title="Mức độ dễ học/dễ hiểu"><i class="bi bi-lightbulb"></i> Learn: <span class="value">${doc.learnability}%</span></span>
                            <span class="criteria-item" title="Cấu trúc mạch lạc"><i class="bi bi-diagram-3"></i> Struct: <span class="value">${doc.structure}%</span></span>
                            <span class="criteria-item" title="Tính thực tế/áp dụng"><i class="bi bi-tools"></i> Pract: <span class="value">${doc.practicality}%</span></span>
                            <span class="criteria-item" title="Tính cập nhật"><i class="bi bi-calendar-check"></i> Update: <span class="value">${doc.updatedness}%</span></span>
                        </div>`;

                    return `
                     <div class="ranking-item ${highlightClass} p-2 rounded">
                         <div class="ranking-main-info">
                             <div class="ranking-info">
                                 <span class="ranking-rank">#${index + 1}</span>
                                 <div class="d-flex align-items-center" style="overflow: hidden;">
                                     <i class="bi ${iconClass} me-1"></i>
                                     <div class="ranking-name" title="${doc.name}">
                                         ${displayName} ${realDocIcon} ${sharedIcon}
                                     </div>
                                     <div class="ranking-details ms-2">(${doc.category || 'N/A'})</div>
                                 </div>
                             </div>
                             <div class="ranking-score">
                                 <span class="rating-stars me-1">${starsHTML}</span>
                                 <span class="score-number text-muted small">(${parseFloat(doc.rating).toFixed(1)})</span>
                             </div>
                         </div>
                         ${criteriaHTML}
                     </div>`;
                }).join('');
            } // Kết thúc generateDocumentRanking

            // === HÀM TẠO RANKING USER (Giữ nguyên) ===
            function generateUserRanking() { if (!userRankingList) return; let usersToRank = fakeUsers.map(name => ({ name: name, score: getUserScore() })); const sharedScore = localStorage.getItem('myTimelineScore'); let myScore = null; if (sharedScore) { myScore = parseInt(sharedScore); if (isNaN(myScore)) { myScore = null; } localStorage.removeItem('myTimelineScore'); } if (myScore !== null) { const existingUserIndex = usersToRank.findIndex(u => u.name === "Bạn"); if (existingUserIndex !== -1) { usersToRank[existingUserIndex].score = myScore; } else { usersToRank.push({ name: "Bạn", score: myScore }); } } let rankedUsers = usersToRank.sort((a, b) => b.score - a.score).slice(0, 10); userRankingList.innerHTML = rankedUsers.map((user, index) => ` <div class="ranking-item"> <div class="ranking-main-info"> <div class="ranking-info"> <span class="ranking-rank">#${index + 1}</span> <div> <div class="ranking-name" style="${user.name === 'Bạn' ? 'color: var(--primary-blue); font-weight: 600;' : ''}"> <i class="bi ${user.name === 'Bạn' ? 'bi-person-check-fill text-primary' : 'bi-person-circle'} me-1"></i>${user.name} </div> </div> </div> <div class="ranking-score">${user.score.toLocaleString('vi-VN')} <small>pts</small></div> </div> </div> `).join(''); }

             // Gắn sự kiện và gọi lần đầu
             if (refreshDocBtn) { refreshDocBtn.addEventListener('click', generateDocumentRanking); }
             if (refreshUserBtn) { refreshUserBtn.addEventListener('click', generateUserRanking); }
             // Gọi hàm ranking sau khi DOM load
             if (typeof generateDocumentRanking === 'function') { generateDocumentRanking(); }
             if (typeof generateUserRanking === 'function') { generateUserRanking(); }

        }); // Kết thúc DOMContentLoaded
    </script>
    </body>
</html>