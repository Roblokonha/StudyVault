{% extends "layout.html" %}

{% block title %}Timeline H·ªçc T·∫≠p - StudyVault{% endblock %}

{% block head_styles %}
    <style>
        /* --- CSS L·ªãch Tu·∫ßn --- */
        .timeline-table-container { background-color: var(--white-bg); border-radius: var(--card-border-radius); padding: 15px; box-shadow: var(--card-shadow); }
        .timeline-table { table-layout: fixed; border-collapse: separate; border-spacing: 5px; width: 100%; }
        .timeline-table th { background-color: #e9ecef; color: #495057; border: none; font-weight: 600; text-align: center; height: auto; padding: 0.5rem 0.25rem; font-size: 0.8em; border-radius: var(--element-border-radius); text-transform: uppercase; }
        .timeline-table td { border: 1px solid #dee2e6 !important; min-height: 100px; height: auto !important; text-align: left; vertical-align: top; padding: 8px !important; font-size: 0.85em !important; position: relative; border-radius: var(--element-border-radius) !important; word-wrap: break-word !important; overflow: hidden !important; background-color: #f8f9fa; transition: background-color 0.2s ease-in-out; border-left: none !important; }
        .timeline-table td .day-number { color: #212529 !important; font-weight: bold !important; display: block !important; margin-bottom: 4px !important; text-align: right !important; font-size: 1em !important; }
        .timeline-table td .activity-content { font-size: 0.9em !important; line-height: 1.4 !important; color: #212529 !important; }
        .timeline-table td .activity-content .badge { font-size: 0.85em !important; padding: 0.25em 0.4em !important; margin-bottom: 3px !important; }
        .timeline-table td.activity-0 { background-color: #f8f9fa !important; }
        .timeline-table td.activity-0 .day-number, .timeline-table td.activity-0 .activity-content { color: #212529 !important; }
        .timeline-table td.activity-0 .activity-content.text-muted { color: #6c757d !important; }
        .timeline-table td.activity-1 { background-color: #c6e48b !important; }
        .timeline-table td.activity-1 .day-number, .timeline-table td.activity-1 .activity-content { color: #333 !important; }
        .timeline-table td.activity-1 .badge { color: #155724 !important; background-color: rgba(255, 255, 255, 0.7) !important; border-color: #c3e6cb !important; }
        .timeline-table td.activity-2 { background-color: #7bc96f !important; }
        .timeline-table td.activity-2 .day-number, .timeline-table td.activity-2 .activity-content { color: #111 !important; }
        .timeline-table td.activity-2 .badge { color: #155724 !important; background-color: rgba(255, 255, 255, 0.75) !important; border-color: #b1dfbb !important; }
        .timeline-table td.activity-3 { background-color: #239a3b !important; color: white !important; }
        .timeline-table td.activity-3 .day-number, .timeline-table td.activity-3 .activity-content { color: white !important; }
        .timeline-table td.activity-3 .badge { color: #196127 !important; background-color: rgba(255, 255, 255, 0.85) !important; border: none !important;}
        .timeline-table td.activity-4 { background-color: #196127 !important; color: white !important; }
        .timeline-table td.activity-4 .day-number, .timeline-table td.activity-4 .activity-content { color: white !important; }
        .timeline-table td.activity-4 .badge { color: #196127 !important; background-color: rgba(255, 255, 255, 0.9) !important; border: none !important; }

        /* --- CSS Ph·∫ßn c√≤n l·∫°i --- */
        .stat-card .card-body { display: flex; align-items: center; justify-content: space-around; flex-wrap: wrap; gap: 1rem;}
        .stat-icon { font-size: 2rem; margin-bottom: 0.25rem;}
        .stat-value { font-size: 1.75rem; font-weight: 600; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); }
        .achievement-badge { padding: 0.4em 0.8em; margin: 2px; display: inline-block;}
        #aiMascotSection { background-color: var(--white-bg); border-radius: var(--card-border-radius); padding: 1.5rem; text-align: center; border-top: 4px solid var(--primary-blue); }
        #mascotIcon { font-size: 3rem; display: block; margin-bottom: 0.5rem; transition: transform 0.3s ease-in-out; }
        #mascotMessage { background-color: #e9ecef; border-radius: var(--element-border-radius); padding: 0.8rem 1rem; min-height: 60px; display: flex; align-items: center; justify-content: center; font-style: italic; color: #495057; transition: background-color 0.3s ease; }
        #personalitySelector label { margin-left: 5px; margin-right: 15px; font-size: 0.9em; cursor: pointer;}
        #personalitySelector .form-check-input { cursor: pointer; }

        /* --- CSS L·ªãch Th√°ng --- */
        .monthly-heatmap-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 1rem; }
        .month-grid { background-color: var(--white-bg); padding: 10px; border-radius: var(--element-border-radius); border: 1px solid #eee;}
        .month-header { font-weight: 500; margin-bottom: 8px; font-size: 0.9rem; text-align: center; color: var(--primary-blue); }
        .month-days-header { display: grid !important; grid-template-columns: repeat(7, 1fr) !important; text-align: center; font-size: 0.65em; color: var(--text-muted); margin-bottom: 4px; padding: 0 2px !important; width: 100% !important; }
         .month-days-header > div { padding: 2px 0; }
        .month-days-grid { display: grid !important; grid-template-columns: repeat(7, 1fr) !important; gap: 2px; }
        .month-day { width: 100%; padding-bottom: 100%; position: relative; border-radius: 3px; background-color: #f0f0f0 !important; transition: background-color 0.2s ease-in-out; border: none; }
        .month-day.activity-1 { background-color: #c6e48b !important; }
        .month-day.activity-2 { background-color: #7bc96f !important; }
        .month-day.activity-3 { background-color: #239a3b !important; }
        .month-day.activity-4 { background-color: #196127 !important; }

        /* --- CSS CHO AI CHAT MODAL --- */
        #aiChatModal .modal-body { display: flex; flex-direction: column; height: 70vh; }
        #chatMessagesArea { flex-grow: 1; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: var(--element-border-radius); margin-bottom: 1rem; background-color: #f8f9fa; }
        .chat-bubble { padding: 0.5rem 0.8rem; border-radius: 1rem; margin-bottom: 0.5rem; max-width: 75%; word-wrap: break-word; line-height: 1.4; }
        .chat-bubble.user { background-color: var(--primary-blue); color: white; margin-left: auto; border-bottom-right-radius: 0.25rem; }
        .chat-bubble.ai { background-color: #e9ecef; color: var(--text-dark); margin-right: auto; border-bottom-left-radius: 0.25rem; }
        .chat-bubble .sender-name { font-size: 0.75em; font-weight: 600; display: block; margin-bottom: 0.2rem; }
    </style>
{% endblock %}

{% block content %}
    <h1 class="mb-4 fw-bold"><i class="bi bi-calendar-check text-primary"></i> D√≤ng th·ªùi gian & Hi·ªáu su·∫•t h·ªçc t·∫≠p</h1>
    <div class="row">
        <div class="col-lg-5">
             <div class="card" id="aiMascotSection">
                 <span id="mascotIcon">üòä</span>
                 <div id="mascotMessage" class="alert alert-secondary">Ch·ªçn m·ªôt t√≠nh c√°ch ƒë·ªÉ b·∫Øt ƒë·∫ßu!</div>
                 <div class="mt-3 text-start" id="personalitySelector">
                     <span class="me-2 small text-muted d-block mb-2">Ch·ªçn t√≠nh c√°ch chatbot:</span>
                     <div class="form-check mb-1">
                         <input class="form-check-input" type="radio" name="aiPersonality" id="p_cute_lover" value="cute_lover" checked>
                         <label class="form-check-label" for="p_cute_lover">üëß Ng∆∞·ªùi y√™u d·ªÖ th∆∞∆°ng</label>
                     </div>
                     <div class="form-check mb-1">
                         <input class="form-check-input" type="radio" name="aiPersonality" id="p_kind_grandparents" value="kind_grandparents">
                         <label class="form-check-label" for="p_kind_grandparents">üëµ √îng b√† hi·ªÅn t·ª´</label>
                     </div>
                     <div class="form-check mb-1">
                        <input class="form-check-input" type="radio" name="aiPersonality" id="p_angry_mom" value="angry_mom">
                         <label class="form-check-label" for="p_angry_mom">üôé‚Äç‚ôÄÔ∏è M·∫π gi·∫≠n d·ªØ</label>
                     </div>
                      <div class="form-check mb-1">
                         <input class="form-check-input" type="radio" name="aiPersonality" id="p_quiet_dad" value="quiet_dad">
                         <label class="form-check-label" for="p_quiet_dad">üßî‚Äç‚ôÇÔ∏è B·ªë √≠t n√≥i</label>
                     </div>
                     <div class="form-check mb-1">
                         <input class="form-check-input" type="radio" name="aiPersonality" id="p_patriarchal_lover" value="patriarchal_lover">
                         <label class="form-check-label" for="p_patriarchal_lover">üôé‚Äç‚ôÇÔ∏è Ng∆∞·ªùi y√™u gia tr∆∞·ªüng</label>
                     </div>
                 </div>
                 <div class="mt-3 pt-3 border-top">
                     <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#aiChatModal">
                         <i class="bi bi-chat-dots-fill me-2"></i>Tr√≤ chuy·ªán √în t·∫≠p v·ªõi AI
                     </button>
                 </div>
             </div>

             <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-calendar3-range me-2"></i>L·ªô tr√¨nh h·ªçc t·∫≠p ƒë·ªÅ xu·∫•t 
                </div>
                <div class="card-body small">
                    <p class="text-muted" id="pathway-description">ƒêang t·∫£i l·ªô tr√¨nh...</p>
                    <ul class="list-group list-group-flush" id="suggested-pathway-list">
                        <li class="list-group-item">ƒêang t·∫£i...</li>
                    </ul>
                     <p class="text-center mt-3">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="change-pathway-btn">
                            <i class="bi bi-shuffle me-1"></i>ƒê·ªïi l·ªô tr√¨nh h·ªçc
                        </button>
                     </p>
                </div>
             </div>

             <div class="card stat-card">
                 <div class="card-header"><i class="bi bi-bar-chart-line-fill"></i> Hi·ªáu su·∫•t Tu·∫ßn N√†y </div>
                 <div class="card-body">
                     <div class="text-center">
                        <i class="bi bi-fire stat-icon text-danger"></i>
                        <div class="stat-value">{{ current_streak }}</div>
                        <div class="stat-label">Ng√†y Streak</div>
                     </div>
                     <div class="text-center">
                        <i class="bi bi-check2-square stat-icon text-success"></i>
                        <div class="stat-value">{{ docs_viewed_today }}</div>
                        <div class="stat-label">Xem h√¥m nay</div>
                     </div>
                     <div class="text-center">
                        <i class="bi bi-clock-history stat-icon text-info"></i>
                        <div class="stat-value">{{ avg_session_minutes }}<small>p</small></div>
                        <div class="stat-label">TB / l·∫ßn h·ªçc</div>
                     </div>
                     <div class="text-center">
                        <i class="bi bi-brain stat-icon text-warning"></i>
                        <div class="stat-value" id="recall-rate-value">--<small>%</small></div>
                        <div class="stat-label">T·ªâ l·ªá Ghi nh·ªõ </div>
                    </div>
                 </div>
                 <div class="card-footer text-muted small"> T·ªïng t√†i li·ªáu ƒë√£ t√≥m t·∫Øt: {{ total_docs_summarized }} </div>
             </div>

             <div class="card">
                 <div class="card-header"><i class="bi bi-calendar-check-fill"></i> H√†ng ƒë·ª£i √în t·∫≠p </div>
                 <ul class="list-group list-group-flush">
                     {% if review_items %}
                         {% for item in review_items %}
                         <li class="list-group-item d-flex justify-content-between align-items-center">
                             <a href="{{ url_for('view_document', document_id=item.id) if item.id else '#' }}" class="text-decoration-none text-dark" title="{{ item.name }}">
                                 <i class="bi bi-file-earmark-text me-2"></i>{{ item.name | truncate(35) }}
                             </a>
                             <span class="badge bg-warning text-dark rounded-pill">{{ item.due }}</span>
                         </li>
                         {% endfor %}
                     {% else %}
                         <li class="list-group-item text-muted">Kh√¥ng c√≥ t√†i li·ªáu n√†o c·∫ßn √¥n t·∫≠p ngay.</li>
                     {% endif %}
                 </ul>
             </div>

             <div class="card">
                 <div class="card-header"><i class="bi bi-award-fill"></i> Th√†nh T·ª±u ƒê·∫°t ƒê∆∞·ª£c </div>
                 <div class="card-body">
                     <div id="achievementsList">
                         {% if earned_achievements %}
                             {% for ach in earned_achievements %}
                             <span class="badge bg-light text-dark border rounded-pill achievement-badge">
                                 <i class="bi {{ ach.icon }} me-1"></i>{{ ach.text }}
                             </span>
                             {% endfor %}
                         {% else %}
                             <p class="text-muted">H√£y b·∫Øt ƒë·∫ßu h·ªçc ƒë·ªÉ m·ªü kh√≥a th√†nh t·ª±u nh√©!</p>
                         {% endif %}
                     </div>
                 </div>
             </div>
        </div>
        <div class="col-lg-7">
             <div class="card">
                <div class="card-header"><i class="bi bi-calendar-week"></i> K·∫ø ho·∫°ch h·ªçc t√¢p</div>
                <div class="card-body p-3">
                     <div class="d-flex align-items-center mb-3 justify-content-center small text-muted">
                        <span class="me-1">√çt</span>
                        <span class="me-1" style="width:15px; height:15px; background-color: #f8f9fa !important; border: 1px solid #ccc; border-radius: 3px;">&nbsp;</span>
                        <span class="me-1" style="width:15px; height:15px; background-color: #c6e48b !important; border-radius: 3px;"></span>
                        <span class="me-1" style="width:15px; height:15px; background-color: #7bc96f !important; border-radius: 3px;"></span>
                        <span class="me-1" style="width:15px; height:15px; background-color: #239a3b !important; border-radius: 3px;"></span>
                        <span class="me-1" style="width:15px; height:15px; background-color: #196127 !important; border-radius: 3px;"></span>
                        <span class="ms-1">Nhi·ªÅu</span>
                     </div>
                     <div class="timeline-table-container bg-transparent p-0 shadow-none border-0">
                        <table class="timeline-table w-100" id="weeklyTimelineTable">
                            <thead> <tr> <th>Hai</th> <th>Ba</th> <th>T∆∞</th> <th>NƒÉm</th> <th>S√°u</th> <th>B·∫£y</th> <th>CN</th> </tr> </thead>
                            <tbody> <tr> <td></td><td></td><td></td><td></td><td></td><td></td><td></td> </tr> </tbody>
                        </table>
                    </div>
                    <p class="text-center small text-muted mt-3">**K·∫ø ho·∫°ch d·ª±a tr√™n m·ª•c ti√™u m√† b·∫°n ƒë√£ thi·∫øt l·∫≠p ·ªü b∆∞·ªõc upload v√† chuy·ªÉn h√≥a c√°c t√†i li·ªáu.**</p>
                </div>
             </div>

             <div class="card">
                 <div class="card-header"><i class="bi bi-calendar-month"></i> Ho·∫°t ƒë·ªông theo Th√°ng </div>
                 <div class="card-body">
                     <p class="text-muted small">Hi·ªÉn th·ªã m·ª©c ƒë·ªô ho·∫°t ƒë·ªông gi·∫£ l·∫≠p trong c√°c th√°ng qua. M√†u √¥ vu√¥ng th·ªÉ hi·ªán m·ª©c ƒë·ªô.</p>
                     <div class="d-flex align-items-center mb-3 justify-content-center small text-muted">
                         <span class="me-1">√çt</span>
                         <span class="badge me-1" style="width:15px; height:15px; background-color: #f8f9fa !important; border: 1px solid #ccc; border-radius: 3px;">&nbsp;</span>
                         <span class="badge me-1" style="width:15px; height:15px; background-color: #c6e48b !important; border-radius: 3px;">&nbsp;</span>
                         <span class="badge me-1" style="width:15px; height:15px; background-color: #7bc96f !important; border-radius: 3px;">&nbsp;</span>
                         <span class="badge me-1" style="width:15px; height:15px; background-color: #239a3b !important; border-radius: 3px;">&nbsp;</span>
                         <span class="badge me-1" style="width:15px; height:15px; background-color: #196127 !important; border-radius: 3px;">&nbsp;</span>
                         <span class="ms-1">Nhi·ªÅu</span>
                      </div>
                     <div id="monthlyActivitySection" class="monthly-heatmap-container">
                         </div>
                 </div>
             </div>

        </div>
    </div>
    <div class="mt-4 mb-5 text-center">
        <a href="{{ url_for('index') }}" class="btn btn-secondary"><i class="bi bi-arrow-left-circle"></i> Quay l·∫°i Dashboard</a>
    </div>

    <div class="modal fade" id="aiChatModal" tabindex="-1" aria-labelledby="aiChatModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="aiChatModalLabel"><i class="bi bi-robot me-2"></i>Tr√≤ chuy·ªán √¥n t·∫≠p v·ªõi AI</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="chatMessagesArea">
                <div class="chat-bubble ai">
                    <span class="sender-name">StudyVault AI</span>
                    Xin ch√†o! H√¥m nay ch√∫ng ta c√πng √¥n t·∫≠p v·ªÅ ch·ªß ƒë·ªÅ g√¨ nh·ªâ? B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu b·∫±ng c√°ch h·ªèi t√¥i m·ªôt c√¢u ho·∫∑c k·ªÉ v·ªÅ m·ªôt t√†i li·ªáu b·∫°n v·ª´a h·ªçc.
                </div>
            </div>
            <div class="input-group mt-auto">
              <input type="text" class="form-control" id="chatInput" placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n...">
              <button class="btn btn-primary" type="button" id="sendChatMessageBtn">
                <i class="bi bi-send-fill"></i> G·ª≠i
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
         const earnedAchievementsData = {{ earned_achievements | tojson | safe }};
         const pathwayExamples = [
             [{ icon: 'bi-book', text: 'ƒê·ªçc Ch∆∞∆°ng 1: T·ªïng quan', time: 'Th·ª© 2 - 60 ph√∫t', title: 'Gi·ªõi thi·ªáu Machine Learning' }, { icon: 'bi-check2-square', text: 'Quiz Ch∆∞∆°ng 1', time: 'Th·ª© 3 - 15 ph√∫t', title: 'Gi·ªõi thi·ªáu Machine Learning' }, { icon: 'bi-book', text: 'ƒê·ªçc Ch∆∞∆°ng 2: Supervised Learning', time: 'Th·ª© 4 - 90 ph√∫t', title: 'Gi·ªõi thi·ªáu Machine Learning' }, { icon: 'bi-pencil-square', text: 'Ghi ch√∫ & T√≥m t·∫Øt Ch∆∞∆°ng 2', time: 'Th·ª© 5 - 30 ph√∫t', title: 'Gi·ªõi thi·ªáu Machine Learning' }, { icon: 'bi-arrow-clockwise', text: '√în t·∫≠p Ch∆∞∆°ng 1 & 2', time: 'Th·ª© 7 - 45 ph√∫t', title: 'Gi·ªõi thi·ªáu Machine Learning' }],
             [{ icon: 'bi-filetype-py', text: 'Setup m√¥i tr∆∞·ªùng Python & Flask', time: 'T·ªëi Th·ª© 2 - 45 ph√∫t', title: 'D·ª± √°n Web Flask' }, { icon: 'bi-journal-code', text: 'T√¨m hi·ªÉu v·ªÅ Routing & Templates', time: 'T·ªëi Th·ª© 3 - 60 ph√∫t', title: 'D·ª± √°n Web Flask' }, { icon: 'bi-database', text: 'K·∫øt n·ªëi Database (SQLAlchemy)', time: 'T·ªëi Th·ª© 5 - 75 ph√∫t', title: 'D·ª± √°n Web Flask' }, { icon: 'bi-card-checklist', text: 'T·∫°o Form ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω', time: 'Chi·ªÅu Th·ª© 7 - 90 ph√∫t', title: 'D·ª± √°n Web Flask' }, { icon: 'bi-bug', text: 'Debug v√† Refactor code', time: 'S√°ng Ch·ªß Nh·∫≠t - 45 ph√∫t', title: 'D·ª± √°n Web Flask' }],
             [{ icon: 'bi-earbuds', text: 'Nghe Podcast Ti·∫øng Anh ch·ªß ƒë·ªÅ Kinh t·∫ø', time: 'S√°ng T2,4,6 - 20 ph√∫t', title: 'C·∫£i thi·ªán Ti·∫øng Anh' }, { icon: 'bi-blockquote-right', text: 'H·ªçc 10 t·ª´ v·ª±ng m·ªõi (Quizlet)', time: 'M·ªói ng√†y - 15 ph√∫t', title: 'C·∫£i thi·ªán Ti·∫øng Anh' }, { icon: 'bi-chat-dots', text: 'Th·ª±c h√†nh n√≥i v·ªõi b·∫°n b√®/AI', time: 'T·ªëi Th·ª© 3, 5 - 30 ph√∫t', title: 'C·∫£i thi·ªán Ti·∫øng Anh' }, { icon: 'bi-book-half', text: 'ƒê·ªçc 1 b√†i b√°o ng·∫Øn (BBC/CNN)', time: 'Tr∆∞a T2-T6 - 25 ph√∫t', title: 'C·∫£i thi·ªán Ti·∫øng Anh' }, { icon: 'bi-pencil', text: 'Vi·∫øt 1 ƒëo·∫°n email/nh·∫≠t k√Ω ng·∫Øn', time: 'T·ªëi Ch·ªß Nh·∫≠t - 30 ph√∫t', title: 'C·∫£i thi·ªán Ti·∫øng Anh' }]
         ];
         let currentPathwayIndex = 0;

         const mascotPersonalities = {
             cute_lover: { icon: 'üëß', dialogues: { reminder: ["Nh·ªõ √¥n b√†i nha t√¨nh y√™u ‚ù§Ô∏è", "Anh/em ∆°i, t·ªõi gi·ªù h·ªçc r·ªìi n√®!", "H·ªçc x√≠u r·ªìi m√¨nh ƒëi ch∆°i nha? üòâ", "ƒê·ª´ng qu√™n m·ª•c ti√™u c·ªßa t·ª•i m√¨nh nha!"], streak_lost: ["Opps, m√¨nh m·∫•t streak r·ªìi... kh√¥ng sao, l√†m l·∫°i t·ª´ ƒë·∫ßu nh√© üí™", "Bu·ªìn √°... H√¥m qua anh/em h·ª©a h·ªçc c√πng em m√†?", "Th√¥i kh√¥ng d·ªói ƒë√¢u, nay h·ªçc b√π nha! üòò"], milestone_streak: ["Wow, {N} ng√†y streak r·ªìi! Gi·ªèi qu√° ƒëi m·∫•t! üòç", "Ch√∫c m·ª´ng t·ª•i m√¨nh ƒë·∫°t {N} ng√†y h·ªçc li√™n t·ª•c!", "Y√™u anh/em nh·∫•t v√¨ s·ª± ki√™n tr√¨ n√†y!"], milestone_docs: ["H·ªçc ƒë∆∞·ª£c {N} t√†i li·ªáu r·ªìi n√®, ƒë·ªânh qu√°! ‚ú®", "C√†y gh√™ v·∫≠y, {N} t√†i li·ªáu r·ªìi ƒë√≥!", "Ki·∫øn th·ª©c ƒë·∫ßy m√¨nh r·ªìi nha!"], generic_greeting: ["H√¥m nay h·ªçc g√¨ n√® t√¨nh y√™u?", "C√≥ em ·ªü ƒë√¢y h·ªçc c√πng anh/em n√®!", "C·ªë l√™n nha ng∆∞·ªùi th∆∞∆°ng!", "M·ªôt ng√†y h·ªçc t·∫≠p vui v·∫ª nh√©!"] } },
             kind_grandparents: { icon: 'üëµ', dialogues: { reminder: ["ƒê·∫øn gi·ªù h·ªçc r·ªìi ƒë√≥ ch√°u", "Ch√°u ∆°i, √¥ng/b√† bi·∫øt h∆°i m·ªát... nh∆∞ng 10 ph√∫t th√¥i nh√©?", "R√°ng h·ªçc cho n√™n ng∆∞·ªùi nha con.", "H·ªçc ch√∫t r·ªìi ngh·ªâ ng∆°i nha ch√°u."], streak_lost: ["Kh√¥ng sao ƒë√¢u, l·ª° b·ªØa th√¥i m√†. Mai h·ªçc l·∫°i nh√©.", "√îng/b√† th·∫•y h∆°i ti·∫øc, nh∆∞ng c·ªë g·∫Øng l√† ƒë∆∞·ª£c.", "Ai c≈©ng c√≥ l√∫c qu√™n m√†, ƒë·ª´ng bu·ªìn nha ch√°u."], milestone_streak: ["Ch√°u gi·ªèi qu√°, {N} ng√†y r·ªìi!", "√îng/b√† m·ª´ng cho ch√°u.", "C·ª© ƒë√† n√†y l√† t·ªët r·ªìi con."], milestone_docs: ["H·ªçc ƒë∆∞·ª£c {N} t√†i li·ªáu r·ªìi, √¥ng/b√† t·ª± h√†o v·ªÅ ch√°u!", "Ch√†, nhi·ªÅu ki·∫øn th·ª©c qu√° ha.", "V·∫≠y l√† s·∫Øp th√†nh t√†i r·ªìi!"], generic_greeting: ["H√¥m nay ch√°u h·ªçc t·ªët kh√¥ng?", "C√≥ c·∫ßn √¥ng/b√† gi√∫p g√¨ kh√¥ng?", "Ch√°u c·ª© t·ª´ t·ª´ m√† h·ªçc.", "√îng/b√† tin ·ªü ch√°u."] } },
             angry_mom: { icon: 'üôé‚Äç‚ôÄÔ∏è', dialogues: { reminder: ["H·ªçc b√†i ngay! Kh√¥ng n√≥i nhi·ªÅu!", "L·∫°i ƒë·ªãnh tr·ªën h·ªçc n·ªØa ƒë·∫•y √†?", "C√≥ bi·∫øt m·∫•y gi·ªù r·ªìi kh√¥ng? Ng·ªìi v√†o b√†n!", "H·ªçc ƒëi ch·ª©, kh√¥ng h·ªçc th√¨ l√†m g√¨?"], streak_lost: ["M·∫•t streak r·ªìi! Th·∫•y ch∆∞a! L∆∞·ªùi n√≥ th·∫ø ƒë·∫•y!", "H√¥m qua l√†m g√¨ m√† kh√¥ng h·ªçc?!", "C·∫•m ƒë∆∞·ª£c l·∫∑p l·∫°i nghe ch∆∞a!", "Li·ªáu h·ªìn ƒë·∫•y!"], milestone_streak: ["ƒê∆∞·ª£c {N} ng√†y r·ªìi ƒë·∫•y √†? T·∫°m ƒë∆∞·ª£c! ƒê·ª´ng c√≥ m√† l∆° l√†!", "C≈©ng bi·∫øt c·ªë g·∫Øng ƒë·∫•y.", "Gi·ªØ cho ch·∫Øc v√†o!", "{N} ng√†y th√¥i, ch∆∞a l√† g√¨ ƒë√¢u!"], milestone_docs: ["H·ªçc ƒë∆∞·ª£c {N} c√°i r·ªìi √†? C√≤n √≠t l·∫Øm!", "Ch·ª´ng n√†y ƒë√£ nh·∫±m nh√≤ g√¨?", "Ph·∫£i h·ªçc nhi·ªÅu h∆°n n·ªØa!", "C√≤n bao nhi√™u c√°i ch∆∞a h·ªçc k√¨a!"], generic_greeting: ["H·ªçc h√†nh nghi√™m t√∫c v√†o!", "ƒê·ª´ng c√≥ l√†m m·∫π t·ª©c!", "T·∫≠p trung!", "Lo m√† h·ªçc ƒëi!"] } },
             quiet_dad: { icon: 'üßî‚Äç‚ôÇÔ∏è', dialogues: { reminder: ["H·ªçc b√†i ƒëi con.", "ƒê·∫øn gi·ªù r·ªìi.", "T·∫≠p trung.", "..."], streak_lost: ["H√¥m qua kh√¥ng h·ªçc √†?", "C·∫ßn c·ªë g·∫Øng h∆°n.", "...", "·ª™m."], milestone_streak: ["{N} ng√†y. T·ªët.", "ƒê∆∞·ª£c.", "Ti·∫øp t·ª•c.", "·ª™m."], milestone_docs: ["{N}.", "ƒê∆∞·ª£c.", "Xem ti·∫øp ƒëi.", "..."], generic_greeting: ["...", "H·ªçc ƒëi.", "·ª™m.", "C·ªë l√™n."] } },
             patriarchal_lover: { icon: 'üôé‚Äç‚ôÇÔ∏è', dialogues: { reminder: ["H·ªçc b√†i! Nghe l·ªùi anh/em!", "Em/anh ph·∫£i h·ªçc, bi·∫øt ch∆∞a?", "ƒê·ª´ng ƒë·ªÉ anh/em nh·∫Øc!", "Lo m√† h·ªçc cho gi·ªèi v√†o!"], streak_lost: ["M·∫•t streak r·ªìi! Anh/em ƒë√£ b·∫£o m√†!", "Th·∫•y t√°c h·∫°i c·ªßa vi·ªác kh√¥ng nghe l·ªùi ch∆∞a?", "L·∫ßn sau ph·∫£i c·ªë h∆°n, r√µ ch∆∞a?", "Th·∫≠t l√† l√†m anh/em th·∫•t v·ªçng!"], milestone_streak: ["ƒê∆∞·ª£c {N} ng√†y r·ªìi, c≈©ng ƒë∆∞·ª£c. Nh∆∞ng ph·∫£i h∆°n n·ªØa!", "T·∫°m ch·∫•p nh·∫≠n.", "ƒê·ª´ng t·ª± m√£n!", "Ph·∫£i gi·ªØ v·ªØng phong ƒë·ªô!"], milestone_docs: ["{N} t√†i li·ªáu. C·∫ßn h·ªçc nhi·ªÅu h∆°n!", "Ph·∫£i ph·∫•n ƒë·∫•u n·ªØa!", "Ki·∫øn th·ª©c l√† ph·∫£i h∆°n ng∆∞·ªùi!", "Ch∆∞a ƒë·ªß ƒë√¢u!"], generic_greeting: ["H·ªçc h√†nh cho c·∫©n th·∫≠n!", "Nghe l·ªùi anh/em!", "Ph·∫£i chƒÉm ch·ªâ!", "ƒê·ª´ng l√†m anh/em phi·ªÅn l√≤ng!"] } }
         };
         
         function displayPathway(pathwayData, pathwayTitle) {
             const listElement = document.getElementById('suggested-pathway-list');
             const descriptionElement = document.getElementById('pathway-description');
             if (!listElement || !descriptionElement) return;
             descriptionElement.textContent = `D·ª±a tr√™n m·ª•c ti√™u v√† th·ªùi h·∫°n c·ªßa b·∫°n cho t√†i li·ªáu "${pathwayTitle}", AI ƒë·ªÅ xu·∫•t l·ªãch tr√¨nh sau:`;
             listElement.innerHTML = '';
             pathwayData.forEach(item => {
                 const li = document.createElement('li');
                 li.className = 'list-group-item d-flex justify-content-between align-items-center';
                 li.innerHTML = `<span><i class="bi ${item.icon} me-1"></i> ${item.text}</span><span class="badge bg-light text-dark rounded-pill">${item.time}</span>`;
                 const iconElement = li.querySelector('i');
                 if (item.icon.includes('book') || item.icon.includes('journal')) iconElement.classList.add('text-primary');
                 else if (item.icon.includes('check') || item.icon.includes('database')) iconElement.classList.add('text-success');
                 else if (item.icon.includes('pencil') || item.icon.includes('card')) iconElement.classList.add('text-info');
                 else if (item.icon.includes('arrow') || item.icon.includes('earbuds') || item.icon.includes('bug')) iconElement.classList.add('text-warning');
                 else if (item.icon.includes('chat') || item.icon.includes('filetype')) iconElement.classList.add('text-primary');
                 listElement.appendChild(li);
             });
         }

         function updateRandomRecallRate() {
             const recallRateElement = document.getElementById('recall-rate-value');
             if (recallRateElement) {
                 const randomRate = Math.floor(Math.random() * (98 - 65 + 1)) + 65;
                 recallRateElement.innerHTML = `${randomRate}<small>%</small>`;
             }
         }

         function randomizeWeeklyTimeline() {
             const weeklyTableBody = document.querySelector("#weeklyTimelineTable tbody");
             if (!weeklyTableBody) return;
             const row = weeklyTableBody.querySelector('tr');
             if (!row) return;
             row.innerHTML = ''; // Clear existing cells
             const sampleActivities = ["ƒê·ªçc t√†i li·ªáu", "Xem video", "T√≥m t·∫Øt", "Quiz", "Nghi√™n c·ª©u", "√în t·∫≠p", "(Ngh·ªâ)", "B√†i t·∫≠p", "Code", "Lab"];
             const sampleTags = ["Python", "Kinh t·∫ø", "To√°n", "IELTS", "Web", "Data", "Lu·∫≠t", "S·ª≠", "VƒÉn"];
             const today = new Date();
             const currentDayOfWeek = (today.getDay() + 6) % 7; 

             for (let index = 0; index < 7; index++) {
                 const cell = document.createElement('td');
                 let activityLevel = Math.floor(Math.random() * 5); 
                 if (index >= 5 && Math.random() < 0.4) { activityLevel = 0; } 
                 cell.className = 'activity-' + activityLevel;

                 const dayNumberSpan = document.createElement('span');
                 dayNumberSpan.className = 'day-number';
                 
                 const activityContentDiv = document.createElement('div');
                 activityContentDiv.className = 'activity-content';

                 let contentHTML = '';
                 const dayDiff = index - currentDayOfWeek;
                 const cellDate = new Date(today);
                 cellDate.setDate(today.getDate() + dayDiff);
                 dayNumberSpan.textContent = cellDate.getDate();

                 if (activityLevel === 0) {
                     contentHTML = '(Ngh·ªâ)';
                     activityContentDiv.classList.add('text-muted');
                 } else {
                     activityContentDiv.classList.remove('text-muted');
                     let activity1 = sampleActivities[Math.floor(Math.random() * sampleActivities.length)];
                     while (activity1 === '(Ngh·ªâ)') { activity1 = sampleActivities[Math.floor(Math.random() * sampleActivities.length)];}
                     contentHTML = activity1;
                     if (activityLevel >= 2 && Math.random() < 0.6) {
                         contentHTML = `<span class="badge bg-primary-subtle text-primary-emphasis rounded-pill">${sampleTags[Math.floor(Math.random() * sampleTags.length)]}</span><br>` + contentHTML;
                     }
                 }
                 activityContentDiv.innerHTML = contentHTML;
                 cell.appendChild(dayNumberSpan);
                 cell.appendChild(activityContentDiv);
                 row.appendChild(cell);
             }
         }

         function generateMonthlyHeatmaps(containerId, numMonthsToShow) {
             const container = document.getElementById(containerId);
             if (!container) return;
             container.innerHTML = '';
             const today = new Date();
             const monthNames = ["Th√°ng 1", "Th√°ng 2", "Th√°ng 3", "Th√°ng 4", "Th√°ng 5", "Th√°ng 6", "Th√°ng 7", "Th√°ng 8", "Th√°ng 9", "Th√°ng 10", "Th√°ng 11", "Th√°ng 12"];
             const dayShortNames = ["T2", "T3", "T4", "T5", "T6", "T7", "CN"];

             for (let i = 0; i < numMonthsToShow; i++) {
                 const targetDate = new Date(today.getFullYear(), today.getMonth() - (numMonthsToShow - 1 - i), 1);
                 const year = targetDate.getFullYear();
                 const month = targetDate.getMonth();

                 const monthDiv = document.createElement('div');
                 monthDiv.className = 'month-grid';
                 const monthHeader = document.createElement('div');
                 monthHeader.className = 'month-header';
                 monthHeader.textContent = `${monthNames[month]} ${year}`;
                 monthDiv.appendChild(monthHeader);

                 const daysHeaderDiv = document.createElement('div');
                 daysHeaderDiv.className = 'month-days-header';
                 dayShortNames.forEach(dayName => {
                     const dayHeader = document.createElement('div');
                     dayHeader.textContent = dayName;
                     daysHeaderDiv.appendChild(dayHeader);
                 });
                 monthDiv.appendChild(daysHeaderDiv);

                 const daysGridDiv = document.createElement('div');
                 daysGridDiv.className = 'month-days-grid';
                 const firstDayOfMonth = new Date(year, month, 1);
                 const daysInMonth = new Date(year, month + 1, 0).getDate();
                 let startingDay = (firstDayOfMonth.getDay() + 6) % 7; 

                 for (let j = 0; j < startingDay; j++) {
                     const emptyCell = document.createElement('div');
                     emptyCell.style.visibility = 'hidden'; // Keep grid structure
                     daysGridDiv.appendChild(emptyCell);
                 }
                 for (let day = 1; day <= daysInMonth; day++) {
                     const dayCell = document.createElement('div');
                     const activityLevel = Math.floor(Math.random() * 5);
                     dayCell.className = `month-day activity-${activityLevel}`;
                     dayCell.title = `${day}/${month + 1}/${year} - M·ª©c ${activityLevel}`;
                     daysGridDiv.appendChild(dayCell);
                 }
                 monthDiv.appendChild(daysGridDiv);
                 container.appendChild(monthDiv);
             }
         }
         
         document.addEventListener('DOMContentLoaded', function() {
            const personalitySelectors = document.querySelectorAll('input[name="aiPersonality"]');
            const mascotIconEl = document.getElementById('mascotIcon');
            const mascotMessageEl = document.getElementById('mascotMessage');
            const currentStreak = typeof {{ current_streak | default(0) }} !== 'undefined' ? {{ current_streak | default(0) }} : 0;
            const docsToday = typeof {{ docs_viewed_today | default(0) }} !== 'undefined' ? {{ docs_viewed_today | default(0) }} : 0;
            const docsSummarized = typeof {{ total_docs_summarized | default(0) }} !== 'undefined' ? {{ total_docs_summarized | default(0) }} : 0;

            function updateMascot() {
                const selectedPersonalityInput = document.querySelector('input[name="aiPersonality"]:checked');
                if (!selectedPersonalityInput || !mascotIconEl || !mascotMessageEl) return;
                const personalityId = selectedPersonalityInput.value;
                const personalityData = mascotPersonalities[personalityId];
                if (!personalityData) return;
                let trigger = 'generic_greeting';
                const rand = Math.random();
                if (currentStreak > 0 && currentStreak % 7 === 0 && rand < 0.4) { trigger = 'milestone_streak'; }
                else if (currentStreak === 0 && rand < 0.3) { trigger = 'streak_lost'; }
                else if (docsSummarized > 0 && docsSummarized % 5 === 0 && rand < 0.4) { trigger = 'milestone_docs'; }
                else if (rand < 0.2) { trigger = 'reminder'; }
                
                let message = "Hmm...";
                const dialoguesForTrigger = personalityData.dialogues[trigger];
                if (dialoguesForTrigger && dialoguesForTrigger.length > 0) {
                    message = dialoguesForTrigger[Math.floor(Math.random() * dialoguesForTrigger.length)];
                    message = message.replace('{N}', trigger === 'milestone_docs' ? docsSummarized : currentStreak);
                } else {
                    const genericDialogues = personalityData.dialogues['generic_greeting'];
                    if (genericDialogues && genericDialogues.length > 0) {
                        message = genericDialogues[Math.floor(Math.random() * genericDialogues.length)];
                    }
                }
                mascotIconEl.textContent = personalityData.icon;
                mascotMessageEl.textContent = message;
                let alertClass = 'alert-secondary';
                if (trigger === 'milestone_streak' || trigger === 'milestone_docs') { alertClass = 'alert-success'; }
                else if (trigger === 'streak_lost' || personalityId === 'angry_mom' || personalityId === 'patriarchal_lover') { alertClass = 'alert-danger'; }
                else if (trigger === 'reminder') { alertClass = 'alert-warning'; }
                else if (personalityId === 'cute_lover') { alertClass = 'alert-info'; }
                else if (personalityId === 'kind_grandparents') { alertClass = 'alert-primary'; }
                mascotMessageEl.className = 'alert ' + alertClass + ' mt-2'; // ƒê·∫£m b·∫£o id kh√¥ng b·ªã ghi ƒë√®
                mascotMessageEl.id = 'mascotMessage'; // Gi·ªØ id cho c√°c truy v·∫•n kh√°c n·∫øu c√≥

                mascotIconEl.style.transform = 'rotate(0deg) scale(1)';
                setTimeout(() => {
                    if(trigger === 'milestone_streak' || trigger === 'milestone_docs') { mascotIconEl.style.transform = 'scale(1.2) rotate(10deg)'; }
                    else if (trigger === 'streak_lost' || personalityId === 'angry_mom') { 
                        mascotIconEl.style.transform = 'translateX(-5px) rotate(-5deg)'; 
                        setTimeout(()=> mascotIconEl.style.transform = 'translateX(5px) rotate(5deg)', 150); 
                        setTimeout(()=> mascotIconEl.style.transform = 'translateX(0px) rotate(0deg)', 300);
                    }
                }, 50);
            }

            if (personalitySelectors.length > 0) {
                personalitySelectors.forEach(radio => { radio.addEventListener('change', updateMascot); });
                updateMascot(); 
            }

            randomizeWeeklyTimeline();
            if (document.getElementById('monthlyActivitySection')) { generateMonthlyHeatmaps('monthlyActivitySection', 4); }
            currentPathwayIndex = Math.floor(Math.random() * pathwayExamples.length);
            if(pathwayExamples.length > 0 && pathwayExamples[currentPathwayIndex] && pathwayExamples[currentPathwayIndex][0]) {
                 displayPathway(pathwayExamples[currentPathwayIndex], pathwayExamples[currentPathwayIndex][0].title);
             } else {
                 const listElement = document.getElementById('suggested-pathway-list');
                 if(listElement) listElement.innerHTML = '<li class="list-group-item text-muted">Ch∆∞a c√≥ l·ªô tr√¨nh m·∫´u.</li>';
                 const descriptionElement = document.getElementById('pathway-description');
                 if(descriptionElement) descriptionElement.textContent = 'Ch∆∞a c√≥ l·ªô tr√¨nh h·ªçc t·∫≠p ƒë·ªÅ xu·∫•t.';
             }
            updateRandomRecallRate();
            const changePathwayBtn = document.getElementById('change-pathway-btn');
            if(changePathwayBtn) { changePathwayBtn.addEventListener('click', function() { let newIndex = Math.floor(Math.random() * pathwayExamples.length); if (pathwayExamples.length > 1) { while (newIndex === currentPathwayIndex) { newIndex = Math.floor(Math.random() * pathwayExamples.length); } } currentPathwayIndex = newIndex; if(pathwayExamples[currentPathwayIndex] && pathwayExamples[currentPathwayIndex][0]) { displayPathway(pathwayExamples[currentPathwayIndex], pathwayExamples[currentPathwayIndex][0].title); } }); }

            // --- JAVASCRIPT CHO AI CHAT MODAL (K·∫øt n·ªëi Backend) ---
            const chatInput = document.getElementById('chatInput');
            const sendChatMessageBtn = document.getElementById('sendChatMessageBtn');
            const chatMessagesArea = document.getElementById('chatMessagesArea');
            const aiChatModalEl = document.getElementById('aiChatModal');
            let aiChatModalInstance = null;
            if (aiChatModalEl) {
                aiChatModalInstance = new bootstrap.Modal(aiChatModalEl);
            }

            function appendMessage(message, sender, senderName = 'B·∫°n') {
                if (!chatMessagesArea) return;
                const bubble = document.createElement('div');
                bubble.classList.add('chat-bubble', sender);
                
                const nameSpan = document.createElement('span');
                nameSpan.classList.add('sender-name');
                const selectedPersonalityLabel = document.querySelector('input[name="aiPersonality"]:checked + label');
                let aiDisplayName = 'StudyVault AI'; 
                if (selectedPersonalityLabel) {
                    aiDisplayName = selectedPersonalityLabel.textContent.trim(); 
                }
                nameSpan.textContent = (sender === 'ai') ? aiDisplayName : senderName;
                
                bubble.appendChild(nameSpan);
                const messageContent = document.createElement('span'); 
                messageContent.textContent = message; 
                bubble.appendChild(messageContent);

                chatMessagesArea.appendChild(bubble);
                chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight; 
            }

            async function handleUserChatMessage() {
                if (!chatInput || !chatMessagesArea) return;
                const messageText = chatInput.value.trim();
                if (messageText === "") return;

                appendMessage(messageText, 'user');
                chatInput.value = "";
                chatInput.disabled = true; 
                sendChatMessageBtn.disabled = true;

                const currentPersonality = document.querySelector('input[name="aiPersonality"]:checked')?.value || 'cute_lover';

                try {
                    const response = await fetch("{{ url_for('ai_chat_converse') }}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            message: messageText,
                            personality: currentPersonality 
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: "L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ server." }));
                        throw new Error(errorData.error || `L·ªói HTTP: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.reply) {
                        appendMessage(data.reply, 'ai');
                    } else if (data.error) {
                        appendMessage(`L·ªói t·ª´ AI: ${data.error}`, 'ai');
                    } else {
                         appendMessage("AI kh√¥ng c√≥ ph·∫£n h·ªìi.", 'ai');
                    }
                } catch (error) {
                    console.error('L·ªói khi g·ª≠i tin nh·∫Øn ƒë·∫øn AI:', error);
                    appendMessage(`Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi AI: ${error.message}`, 'ai');
                } finally {
                    chatInput.disabled = false; 
                    sendChatMessageBtn.disabled = false;
                    chatInput.focus(); 
                }
            }

            if (sendChatMessageBtn) {
                sendChatMessageBtn.addEventListener('click', handleUserChatMessage);
            }
            if (chatInput) {
                chatInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        handleUserChatMessage();
                    }
                });
            }
            if (aiChatModalEl) {
                aiChatModalEl.addEventListener('show.bs.modal', function () {
                    if (chatInput) chatInput.focus();
                });
            }
         });
    </script>
{% endblock %}