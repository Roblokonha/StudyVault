<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <title>Timeline Học Tập (Demo) - StudyVault</title>
    <style>
        /* --- Phong cách chung --- */
        :root { --primary-blue: #0d6efd; --light-bg: #f8f9fa; --white-bg: #ffffff; --card-border-radius: 0.75rem; --element-border-radius: 0.5rem; --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); --text-dark: #212529; --text-muted: #6c757d; --green-act-1: #c6e48b; --green-act-2: #7bc96f; --green-act-3: #239a3b; --green-act-4: #196127;}
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--light-bg); color: var(--text-dark); }
        .navbar { background-color: var(--white-bg) !important; box-shadow: var(--card-shadow); }
        .navbar-brand { color: var(--text-dark) !important; font-weight: 600; }
        .navbar-brand i { color: var(--primary-blue); }
        .nav-link { color: #495057 !important; font-weight: 500; }
        .nav-link.active { color: var(--primary-blue) !important; font-weight: 600;}
        .card { border-radius: var(--card-border-radius); border: none; box-shadow: var(--card-shadow); margin-bottom: 1.5rem; background-color: var(--white-bg); border-top: 4px solid var(--primary-blue); }
        .card-header { background-color: transparent; border-bottom: 1px solid #f1f3f5; font-weight: 600; padding: 1rem 1.25rem; color: var(--primary-blue); }
         .card-header i { color: var(--primary-blue) !important; }
        .btn { border-radius: var(--element-border-radius); padding: 0.5rem 1rem; font-weight: 500; }
        .btn-primary { background-color: var(--primary-blue); border-color: var(--primary-blue); }
        .btn-primary:hover { background-color: #0b5ed7; border-color: #0a58ca; }
        .btn-secondary { background-color: #6c757d; border-color: #6c757d; color: white;}
        .btn-secondary:hover { background-color: #5a6268; border-color: #545b62;}
        .form-control, .form-select, .form-check-input { border-radius: var(--element-border-radius); border-color: #dee2e6; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .form-check-input:checked { background-color: var(--primary-blue); border-color: var(--primary-blue); }
        .badge { border-radius: 50px; font-weight: 500; padding: 0.35em 0.65em; }
        h1 { margin-bottom: 1.5rem !important; font-weight: 600; color: var(--primary-blue); }
         h1 i { color: var(--primary-blue) !important; }
        .list-group-item { border-color: #f1f3f5; padding-top: 0.75rem; padding-bottom: 0.75rem;}

        /* --- CSS Lịch Tuần (Sử dụng Background Xanh Lá - Tăng Cường CSS) --- */
        .timeline-table-container { background-color: var(--white-bg); border-radius: var(--card-border-radius); padding: 15px; box-shadow: var(--card-shadow); }
        .timeline-table { table-layout: fixed; border-collapse: separate; border-spacing: 5px; width: 100%; }
        .timeline-table th { background-color: #e9ecef; color: #495057; border: none; font-weight: 600; text-align: center; height: auto; padding: 0.5rem 0.25rem; font-size: 0.8em; border-radius: var(--element-border-radius); text-transform: uppercase; }
        .timeline-table td {
            border: 1px solid #dee2e6 !important; /* Viền rõ hơn */
            min-height: 100px;
            height: auto !important; /* Bỏ height cố định, để nội dung quyết định */
            text-align: left;
            vertical-align: top;
            padding: 8px !important;
            font-size: 0.85em !important;
            position: relative;
            border-radius: var(--element-border-radius) !important;
            word-wrap: break-word !important;
            overflow: hidden !important;
            background-color: #f8f9fa; /* Nền mặc định */
            transition: background-color 0.2s ease-in-out;
            border-left: none !important; /* Bỏ border left */
        }

        /* --- Màu sắc Hoạt động và Chữ (Xanh Lá - Tăng Cường CSS) --- */
        .timeline-table td .day-number { color: #212529 !important; font-weight: bold !important; display: block !important; margin-bottom: 4px !important; text-align: right !important; font-size: 1em !important; }
        .timeline-table td .activity-content { font-size: 0.9em !important; line-height: 1.4 !important; color: #212529 !important; }
        .timeline-table td .activity-content .badge { font-size: 0.85em !important; padding: 0.25em 0.4em !important; margin-bottom: 3px !important; }

        .timeline-table td.activity-0 { background-color: #f8f9fa !important; }
        .timeline-table td.activity-0 .day-number, .timeline-table td.activity-0 .activity-content { color: #212529 !important; }
        .timeline-table td.activity-0 .activity-content.text-muted { color: #6c757d !important; }

        .timeline-table td.activity-1 { background-color: var(--green-act-1) !important; }
        .timeline-table td.activity-1 .day-number, .timeline-table td.activity-1 .activity-content { color: #333 !important; } /* Chữ đậm hơn */
        .timeline-table td.activity-1 .badge { color: #155724 !important; background-color: rgba(255, 255, 255, 0.7) !important; border-color: #c3e6cb !important; }

        .timeline-table td.activity-2 { background-color: var(--green-act-2) !important; }
        .timeline-table td.activity-2 .day-number, .timeline-table td.activity-2 .activity-content { color: #111 !important; } /* Chữ đen hơn */
        .timeline-table td.activity-2 .badge { color: #155724 !important; background-color: rgba(255, 255, 255, 0.75) !important; border-color: #b1dfbb !important; }

        .timeline-table td.activity-3 { background-color: var(--green-act-3) !important; color: white !important; }
        .timeline-table td.activity-3 .day-number, .timeline-table td.activity-3 .activity-content { color: white !important; }
        .timeline-table td.activity-3 .badge { color: #196127 !important; background-color: rgba(255, 255, 255, 0.85) !important; border: none !important;}

        .timeline-table td.activity-4 { background-color: var(--green-act-4) !important; color: white !important; }
        .timeline-table td.activity-4 .day-number, .timeline-table td.activity-4 .activity-content { color: white !important; }
        .timeline-table td.activity-4 .badge { color: #196127 !important; background-color: rgba(255, 255, 255, 0.9) !important; border: none !important; }


        /* --- CSS Phần còn lại (Stats, AI, Achievements, Monthly) --- */
        .stat-card .card-body { display: flex; align-items: center; justify-content: space-around; }
        .stat-icon { font-size: 2rem; margin-bottom: 0.25rem;}
        .stat-value { font-size: 1.75rem; font-weight: 600; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); }
        .achievement-badge { padding: 0.4em 0.8em;}
        #aiMascotSection { background-color: var(--white-bg); border-radius: var(--card-border-radius); padding: 1.5rem; text-align: center; border-top: 4px solid var(--primary-blue); }
        #mascotIcon { font-size: 3rem; display: block; margin-bottom: 0.5rem; }
        #mascotMessage { background-color: #e9ecef; border-radius: var(--element-border-radius); padding: 0.8rem 1rem; min-height: 60px; display: flex; align-items: center; justify-content: center; font-style: italic; color: #495057; }
        #aiMoodSelector label { margin-left: 5px; margin-right: 15px; font-size: 0.9em; }

        /* --- CSS Lịch Tháng (Sửa lỗi hiển thị) --- */
        .monthly-heatmap-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 1rem; }
        .month-grid { background-color: var(--white-bg); padding: 10px; border-radius: var(--element-border-radius); border: 1px solid #eee;}
        .month-header { font-weight: 500; margin-bottom: 8px; font-size: 0.9rem; text-align: center; color: var(--primary-blue); }
        .month-days-header {
            display: grid !important; /* <<< Ép kiểu hiển thị */
            grid-template-columns: repeat(7, 1fr) !important; /* <<< Chia 7 cột */
            text-align: center; font-size: 0.65em; color: var(--text-muted); margin-bottom: 4px; padding: 0 2px !important; /* <<< Reset padding */ width: 100% !important; /* <<< Đảm bảo full width */
        }
         .month-days-header > div { /* Style cho từng chữ T2, T3... */
             padding: 2px 0;
         }
        .month-days-grid {
            display: grid !important; /* <<< Ép kiểu hiển thị */
            grid-template-columns: repeat(7, 1fr) !important; /* <<< Chia 7 cột */
            gap: 2px;
        }
        .month-day {
            width: 100%;
            padding-bottom: 100%; /* Giữ tỷ lệ vuông */
            position: relative;
            border-radius: 3px;
            background-color: #f0f0f0 !important; /* <<< Màu nền ô trống + important */
            transition: background-color 0.2s ease-in-out;
            border: none;
        }
        /* Màu cho ô tháng - Dùng màu xanh lá */
        .month-day.activity-1 { background-color: var(--green-act-1) !important; }
        .month-day.activity-2 { background-color: var(--green-act-2) !important; }
        .month-day.activity-3 { background-color: var(--green-act-3) !important; }
        .month-day.activity-4 { background-color: var(--green-act-4) !important; }

    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 sticky-top">
        <div class="container"> <a class="navbar-brand fw-bold" href="{{ url_for('index') }}"><i class="bi bi-book-half text-primary"></i> StudyVault</a> <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button> <div class="collapse navbar-collapse" id="navbarNav"> <ul class="navbar-nav ms-auto"> <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}">Dashboard</a></li> <li class="nav-item"><a class="nav-link" href="{{ url_for('upload_file') }}">Tải lên</a></li> <li class="nav-item"><a class="nav-link active" aria-current="page" href="{{ url_for('study_timeline') }}">Timeline</a></li> <li class="nav-item"><a class="nav-link" href="{{ url_for('lazy_market') }}">LazyMarket & Cộng đồng</a></li> </ul> </div> </div>
    </nav>

    <div class="container mt-4">
        <h1 class="mb-4 fw-bold"><i class="bi bi-calendar-check text-primary"></i> Dòng thời gian & Hiệu suất học tập</h1>
        <div class="row">
            <div class="col-lg-5">
                 <div class="card" id="aiMascotSection"> <span id="mascotIcon">🦉</span> <div id="mascotMessage" class="alert alert-info">Chào bạn! Cùng xem tiến độ học tập hôm nay nhé!</div> <div class="mt-3" id="aiMoodSelector"> <span class="me-2 small text-muted">Tâm trạng Cú:</span> <div class="form-check form-check-inline"> <input class="form-check-input" type="radio" name="aiMood" id="moodFriendly" value="friendly" checked> <label class="form-check-label" for="moodFriendly">Thân thiện</label> </div> <div class="form-check form-check-inline"> <input class="form-check-input" type="radio" name="aiMood" id="moodStrict" value="strict"> <label class="form-check-label" for="moodStrict">Nghiêm khắc</label> </div> <div class="form-check form-check-inline"> <input class="form-check-input" type="radio" name="aiMood" id="moodSad" value="sad"> <label class="form-check-label" for="moodSad">Ủ rũ</label> </div> </div> </div>
                 <div class="card stat-card"> <div class="card-header"><i class="bi bi-bar-chart-line-fill"></i> Hiệu suất Tuần Này (Demo)</div> <div class="card-body"> <div class="text-center"> <i class="bi bi-fire stat-icon text-danger"></i> <div class="stat-value">{{ current_streak }}</div> <div class="stat-label">Ngày Streak</div> </div> <div class="text-center"> <i class="bi bi-check2-square stat-icon text-success"></i> <div class="stat-value">{{ docs_viewed_today }}</div> <div class="stat-label">Xem hôm nay</div> </div> <div class="text-center"> <i class="bi bi-clock-history stat-icon text-info"></i> <div class="stat-value">{{ avg_session_minutes }}<small>p</small></div> <div class="stat-label">TB / lần học</div> </div> </div> <div class="card-footer text-muted small"> Tổng tài liệu đã tóm tắt: {{ total_docs_summarized }} </div> </div>
                 <div class="card"> <div class="card-header"><i class="bi bi-calendar-check-fill"></i> Hàng đợi Ôn tập (Demo)</div> <ul class="list-group list-group-flush"> {% if review_items %} {% for item in review_items %} <li class="list-group-item d-flex justify-content-between align-items-center"> <a href="{{ url_for('view_document', document_id=item.id) if item.id else '#' }}" class="text-decoration-none text-dark" title="{{ item.name }}"><i class="bi bi-file-earmark-text me-2"></i>{{ item.name | truncate(35) }}</a> <span class="badge bg-warning text-dark rounded-pill">{{ item.due }}</span> </li> {% endfor %} {% else %} <li class="list-group-item text-muted">Không có tài liệu nào cần ôn tập ngay.</li> {% endif %} </ul> </div>
                 <div class="card"> <div class="card-header"><i class="bi bi-award-fill"></i> Thành Tựu Đạt Được (Demo)</div> <div class="card-body"> <div id="achievementsList"> {% for ach in earned_achievements %} <span class="achievement-badge"> <i class="bi {{ ach.icon }}"></i> {{ ach.text }} </span> {% else %} <p class="text-muted">Hãy bắt đầu học để mở khóa thành tựu nhé!</p> {% endfor %} </div> <hr> <button id="shareAchievementsBtn" class="btn btn-primary w-100"> <i class="bi bi-share-fill"></i> Cập nhật Điểm vào BXH </button> </div> </div>
            </div>

            <div class="col-lg-7">
                 <div class="card">
                    <div class="card-header"><i class="bi bi-calendar-week"></i> Hoạt động Tuần Này (Ngẫu nhiên)</div>
                    <div class="card-body p-3">
                         <div class="d-flex align-items-center mb-3 justify-content-center small text-muted">
                            <span class="me-1">Ít</span>
                            <span class="me-1" style="width:15px; height:15px; background-color: #f8f9fa !important; border: 1px solid #ccc;">&nbsp;</span>
                            <span class="me-1" style="width:15px; height:15px; background-color: var(--green-act-1) !important; border-radius: 3px;"></span>
                            <span class="me-1" style="width:15px; height:15px; background-color: var(--green-act-2) !important; border-radius: 3px;"></span>
                            <span class="me-1" style="width:15px; height:15px; background-color: var(--green-act-3) !important; border-radius: 3px;"></span>
                            <span class="me-1" style="width:15px; height:15px; background-color: var(--green-act-4) !important; border-radius: 3px;"></span>
                            <span class="ms-1">Nhiều</span>
                         </div>
                         <div class="timeline-table-container bg-transparent p-0 shadow-none border-0">
                            <table class="timeline-table w-100" id="weeklyTimelineTable">
                                <thead> <tr> <th>Hai</th> <th>Ba</th> <th>Tư</th> <th>Năm</th> <th>Sáu</th> <th>Bảy</th> <th>CN</th> </tr> </thead>
                                <tbody> <tr> <td></td><td></td><td></td><td></td><td></td><td></td><td></td> </tr> </tbody>
                            </table>
                        </div>
                        <p class="text-center small text-muted mt-3">**Dữ liệu hoạt động tuần này được tạo ngẫu nhiên.**</p>
                    </div>
                 </div>

                 <div class="card">
                     <div class="card-header"><i class="bi bi-calendar-month"></i> Hoạt động theo Tháng (Demo Ngẫu nhiên)</div>
                     <div class="card-body">
                         <p class="text-muted small">Hiển thị mức độ hoạt động giả lập trong các tháng qua. Màu ô vuông thể hiện mức độ.</p>
                         <div class="d-flex align-items-center mb-3 justify-content-center small text-muted">
                             <span class="me-1">Ít</span>
                             <span class="badge me-1" style="width:15px; height:15px; background-color: #f8f9fa !important; border: 1px solid #ccc;">&nbsp;</span>
                             <span class="badge me-1" style="width:15px; height:15px; background-color: var(--green-act-1) !important;">&nbsp;</span>
                             <span class="badge me-1" style="width:15px; height:15px; background-color: var(--green-act-2) !important;">&nbsp;</span>
                             <span class="badge me-1" style="width:15px; height:15px; background-color: var(--green-act-3) !important;">&nbsp;</span>
                             <span class="badge me-1" style="width:15px; height:15px; background-color: var(--green-act-4) !important;">&nbsp;</span>
                             <span class="ms-1">Nhiều</span>
                          </div>
                         <div id="monthlyActivitySection" class="monthly-heatmap-container">
                             </div>
                     </div>
                 </div>

            </div> </div> <div class="mt-4 mb-5 text-center"> <a href="{{ url_for('index') }}" class="btn btn-secondary"><i class="bi bi-arrow-left-circle"></i> Quay lại Dashboard</a> </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
         // --- Lấy dữ liệu thành tựu từ Flask để JS sử dụng ---
         const earnedAchievementsData = {{ earned_achievements | tojson | safe }};

         // --- HÀM SHARE ACHIEVEMENTS ---
         function shareAchievements() { console.log("shareAchievements called!"); const achievementsContainer = document.getElementById('achievementsList'); const achievementsCount = achievementsContainer ? achievementsContainer.querySelectorAll('.achievement-badge').length : (Array.isArray(earnedAchievementsData) ? earnedAchievementsData.length : 0); console.log("Achievements count:", achievementsCount); const baseScore = achievementsCount * 4000; const bonusScore = Math.floor(Math.random() * 151) + 50; const totalScore = baseScore + bonusScore; console.log(`Calculated score: ${totalScore} (Base: ${baseScore}, Bonus: ${bonusScore})`); if (typeof(Storage) !== "undefined") { localStorage.setItem('myTimelineScore', totalScore); console.log(`Timeline score saved to localStorage: ${totalScore}`); window.location.href = "/lazymarket#ranking-tab"; } else { console.error("LocalStorage is not supported!"); alert("Trình duyệt của bạn không hỗ trợ lưu trữ cục bộ, không thể cập nhật điểm."); } }

         // --- ĐỊNH NGHĨA LỜI THOẠI ---
         const mascotDialogues = { friendly: { streak: ["Tuyệt vời! Bạn đã giữ vững {N} ngày streak! Cố lên!", "Chuỗi {N} ngày rồi! Bạn đang làm rất tốt!", "Wow, {N} ngày liên tục! Giữ vững phong độ nhé!", "Tiếp tục phát huy! Streak {N} ngày thật ấn tượng!", "Đà này cứ giữ nhé, {N} ngày streak rồi!", "Bạn thật kiên trì! {N} ngày rồi đấy!", "Cú rất vui vì bạn chăm chỉ {N} ngày qua!", "Mỗi ngày một bước, {N} ngày thật đáng nể!", "Đừng quên tự thưởng cho mình sau {N} ngày cố gắng nha!", "Hành trình {N} ngày của bạn thật truyền cảm hứng!"], no_streak: ["Không sao cả! Bắt đầu lại chuỗi streak mới ngay hôm nay nào!", "Mỗi ngày mới là một cơ hội mới để bắt đầu!", "Đừng nản lòng, hôm nay là ngày tuyệt vời để học!", "Cú tin bạn sẽ sớm có lại streak thôi!", "Hãy biến hôm nay thành ngày đầu tiên của chuỗi mới!", "Bắt đầu lại thôi, không có gì là quá muộn!", "Một chút gián đoạn không sao, quan trọng là tiếp tục!", "Cú luôn ở đây cổ vũ bạn lấy lại phong độ!", "Hôm nay cố gắng nhé, ngày mai sẽ tốt hơn!", "Sẵn sàng cho một khởi đầu mới chưa nào?"] }, strict: { streak: ["Streak: {N} ngày. Tốt. Đừng dừng lại.", "{N} ngày. Duy trì kỷ luật là chìa khóa.", "Tiếp tục. Mục tiêu còn ở phía trước. ({N} ngày)", "Đừng lơ là. Streak {N} ngày cần được bảo vệ.", "{N} ngày rồi. Đảm bảo hoàn thành nhiệm vụ hôm nay.", "Sự nhất quán tạo nên kết quả. ({N} ngày)", "Ghi nhận: {N} ngày. Yêu cầu tiếp tục.", "Không có thời gian nghỉ ngơi. {N} ngày streak.", "Tập trung. {N} ngày chỉ là khởi đầu.", "Tiến độ: {N} ngày. Phải duy trì."], no_streak: ["Streak đã mất! Tập trung lại ngay! Không được lười biếng!", "Thất bại trong việc duy trì streak. Cần nghiêm túc hơn!", "Tại sao lại dừng? Bắt đầu lại ngay lập tức!", "Không có lý do gì cho sự gián đoạn. Học đi!", "Hậu quả của việc lơ là: mất streak. Phải khắc phục!", "Đừng để việc này lặp lại. Bắt đầu lại ngay!", "Thời gian là vàng bạc. Đừng lãng phí thêm!", "Yêu cầu quay lại guồng học tập ngay!", "Kỷ luật đâu rồi? Lấy lại streak ngay!", "Cơ hội đã mất. Phải nỗ lực gấp đôi!"] }, sad: { streak: ["Streak {N} ngày rồi! Đừng làm Cú buồn nha...", "Bạn vẫn đang cố gắng ({N} ngày), Cú đỡ buồn hơn chút...", "Nhớ duy trì nhé, Cú không muốn mất streak này đâu... ({N} ngày)", "Cú hơi lo lắng... nhưng bạn vẫn còn streak {N} ngày.", "({N} ngày) ... Liệu bạn có giữ được không?", "Hy vọng ngày mai vẫn thấy streak {N+1}...", "Đừng bỏ rơi Cú và streak {N} ngày nha...", "Cố gắng thêm chút nữa nhé... ({N} ngày)", "Cú sẽ vui hơn nếu bạn giữ được streak dài hơn... ({N} ngày)", "Chỉ cần đừng dừng lại là được... ({N} ngày)"], no_streak: ["Ôi không... streak mất rồi... Cú buồn lắm...", "Tại sao lại như vậy chứ... Cú rất thất vọng...", "Buồn quá... không còn thấy streak nữa...", "Giá như bạn cố thêm chút nữa...", "Cú không biết nói gì hơn... thật đáng tiếc...", "Có lẽ hôm nay bạn không vui... Cú cũng vậy...", "Mất streak rồi... cảm giác thật tệ...", "Hy vọng bạn sẽ sớm vui vẻ và học lại...", "Cú nhớ những ngày có streak...", "Thôi thì... ngày mai cố gắng nhé..."] } };

        document.addEventListener('DOMContentLoaded', function() {
           // --- Script AI Mascot ---
           const moodSelectors = document.querySelectorAll('input[name="aiMood"]'); const mascotIcon = document.getElementById('mascotIcon'); const mascotMessage = document.getElementById('mascotMessage'); const currentStreak = typeof {{ current_streak | default(0) }} !== 'undefined' ? {{ current_streak | default(0) }} : 0; function updateMascot() { const selectedMoodInput = document.querySelector('input[name="aiMood"]:checked'); if (!selectedMoodInput) return; const selectedMood = selectedMoodInput.value; let icon = '🦉'; let message = ''; let alertClass = 'alert-info'; const streakStatus = currentStreak > 0 ? 'streak' : 'no_streak'; const dialoguesForMood = mascotDialogues[selectedMood]; if (!dialoguesForMood) { console.error("Invalid mood selected:", selectedMood); return; } const possibleMessages = dialoguesForMood[streakStatus]; if (possibleMessages && possibleMessages.length > 0) { message = possibleMessages[Math.floor(Math.random() * possibleMessages.length)]; message = message.replace('{N}', currentStreak); message = message.replace('{N+1}', currentStreak + 1); } else { message = "Cú đang không biết nói gì..."; } if (streakStatus === 'streak') { if (selectedMood === 'friendly') { icon = '🥳'; alertClass = 'alert-success'; } else if (selectedMood === 'strict') { icon = '🧐'; alertClass = 'alert-warning'; } else { icon = '🥺'; alertClass = 'alert-primary'; } } else { if (selectedMood === 'friendly') { icon = '💪'; alertClass = 'alert-info'; } else if (selectedMood === 'strict') { icon = '😠'; alertClass = 'alert-danger'; } else { icon = '😢'; alertClass = 'alert-secondary'; } } if (mascotIcon) mascotIcon.textContent = icon; if (mascotMessage) { mascotMessage.textContent = message; mascotMessage.className = 'alert ' + alertClass; mascotMessage.id = 'mascotMessage'; } } if (moodSelectors.length > 0) { moodSelectors.forEach(radio => { radio.addEventListener('change', updateMascot); }); updateMascot(); }

            // --- Script Randomize Lịch Tuần (Dùng Background Xanh Lá) ---
            function randomizeWeeklyTimeline() { const weeklyTableBody = document.querySelector("#weeklyTimelineTable tbody"); if (!weeklyTableBody) { console.error("Weekly timeline table body not found!"); return; } const row = weeklyTableBody.querySelector('tr'); if (!row) { console.error("Weekly timeline table row not found!"); return; } row.innerHTML = ''; const sampleActivities = [ "Đọc tài liệu", "Xem video bài giảng", "Tóm tắt chương", "Làm Quiz ôn tập", "Tìm hiểu Link tham khảo", "Ôn tập Flashcards", "(Nghỉ ngơi)", "Giải bài tập", "Viết Code Demo", "Thực hành Lab", "Nghiên cứu Case Study", "Thảo luận nhóm", "Chuẩn bị thuyết trình", "Ghi chú ý chính", "Nghe Podcast học thuật", "Đọc báo cáo", "Phân tích dữ liệu", "Viết luận", "Sửa bài viết", "Brainstorm ý tưởng", "Lập dàn ý", "Học từ vựng mới", "Luyện nghe hội thoại", "Tập viết đoạn văn", "Luyện phát âm", "Dịch tài liệu", "Tìm kiếm thông tin", "Soạn slide", "Xem lại ghi chú cũ", "Thử giải thích lại khái niệm", "Tham gia Webinar", "Đọc sách chuyên khảo", "Học công thức", "Chứng minh định lý", "Vẽ sơ đồ tư duy", "Lập kế hoạch học tập", "Xem phim tài liệu", "Thực hành kỹ năng mềm", "Tìm lỗi code", "Review code bạn", "(Giải lao ngắn)", "Code LeetCode", "Đọc sách tiếng Anh" ]; const sampleTags = [ "Python", "Kinh tế", "Giải tích", "IELTS", "Thuyết trình", "Web",  "Thống kê", "Tiếng Nhật", "Khoa học", "Java", "Tài chính", "Đại số", "Tiếng Pháp", "App Mobile", "Data Science",  "Vật lý", "Tiếng Trung",  "Đồ án", "Thuật toán", "Kế toán", "Hình học", "Ngữ pháp", "UI/UX", "Seminar",  "Điện tử",  "Lịch sử",  "Viết Email", "Dự án",  "Blockchain", "Network", "Triết học" ]; const today = new Date(); const currentDayOfWeek = (today.getDay() + 6) % 7; for (let index = 0; index < 7; index++) { const cell = document.createElement('td'); let activityLevel = Math.floor(Math.random() * 5); if (index >= 5 && Math.random() < 0.4) { activityLevel = 0; } cell.className = 'activity-' + activityLevel; const dayNumberSpan = document.createElement('span'); dayNumberSpan.className = 'day-number'; const activityContentDiv = document.createElement('div'); activityContentDiv.className = 'activity-content'; let contentHTML = ''; let dayNumber = '??'; const dayDiff = index - currentDayOfWeek; const cellDate = new Date(today); cellDate.setDate(today.getDate() + dayDiff); dayNumber = cellDate.getDate(); dayNumberSpan.textContent = dayNumber; if (activityLevel === 0) { contentHTML = '(Nghỉ)'; activityContentDiv.classList.add('text-muted'); } else { activityContentDiv.classList.remove('text-muted'); let activity1 = sampleActivities[Math.floor(Math.random() * sampleActivities.length)]; while (activity1 === '(Nghỉ ngơi)' || activity1 === '(Giải lao ngắn)') { activity1 = sampleActivities[Math.floor(Math.random() * sampleActivities.length)]; } contentHTML = activity1; let hasTag = false; if (activityLevel >= 2 && Math.random() < 0.6) { contentHTML = `<span class="badge bg-primary-subtle text-primary-emphasis rounded-pill">${sampleTags[Math.floor(Math.random() * sampleTags.length)]}</span><br>` + contentHTML; hasTag = true; } if (activityLevel >= 3 && Math.random() < (hasTag ? 0.3 : 0.6)) { let activity2 = sampleActivities[Math.floor(Math.random() * sampleActivities.length)]; while (activity2 === activity1 || activity2 === '(Nghỉ ngơi)' || activity2 === '(Giải lao ngắn)') { activity2 = sampleActivities[Math.floor(Math.random() * sampleActivities.length)]; } contentHTML += `<br>${activity2}`; } } activityContentDiv.innerHTML = contentHTML; cell.appendChild(dayNumberSpan); cell.appendChild(activityContentDiv); row.appendChild(cell); } }
            randomizeWeeklyTimeline();

            // Script Tạo Lịch Tháng (Liên tiếp - Đã sửa CSS và kiểm tra JS)
            function generateMonthlyHeatmaps(containerId, numMonthsToShow) {
                const container = document.getElementById(containerId);
                if (!container) { console.error("Monthly heatmap container not found!", containerId); return; }
                container.innerHTML = ''; // Clear previous content
                console.log("Attempting to generate monthly heatmaps..."); // Log start

                const today = new Date();
                const monthNames = ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"];
                const dayShortNames = ["T2", "T3", "T4", "T5", "T6", "T7", "CN"];
                const totalLookbackRange = 12;
                const randomStartOffset = Math.floor(Math.random() * (totalLookbackRange - numMonthsToShow + 1)) - (totalLookbackRange - 1);
                let selectedMonths = [];

                for (let i = 0; i < numMonthsToShow; i++) {
                    const targetDate = new Date(today.getFullYear(), today.getMonth() + randomStartOffset + i, 1);
                    selectedMonths.push({ year: targetDate.getFullYear(), month: targetDate.getMonth() });
                }
                console.log("Selected months:", selectedMonths); // Log tháng đã chọn

                selectedMonths.forEach(monthInfo => {
                    const year = monthInfo.year;
                    const month = monthInfo.month; // 0-11
                    const firstDayOfMonth = new Date(year, month, 1);
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    let startingDay = (firstDayOfMonth.getDay() + 6) % 7; // 0=Mon, 6=Sun

                    const monthDiv = document.createElement('div');
                    monthDiv.className = 'month-grid'; // Class cho style card của tháng

                    const monthHeader = document.createElement('div');
                    monthHeader.className = 'month-header'; // Class cho tiêu đề tháng
                    monthHeader.textContent = `${monthNames[month]} ${year}`;
                    monthDiv.appendChild(monthHeader);

                    const daysHeaderDiv = document.createElement('div');
                    daysHeaderDiv.className = 'month-days-header'; // Class cho header ngày (T2,T3..)
                    dayShortNames.forEach(dayName => {
                         const dayHeader = document.createElement('div');
                         dayHeader.textContent = dayName;
                         daysHeaderDiv.appendChild(dayHeader);
                    });
                    monthDiv.appendChild(daysHeaderDiv);

                    const daysGridDiv = document.createElement('div');
                    daysGridDiv.className = 'month-days-grid'; // Class cho lưới chứa các ô ngày
                    console.log(`Generating grid for ${monthNames[month]} ${year}. Days: ${daysInMonth}, Start Day Index: ${startingDay}`); // Log thông tin tháng

                    // Thêm ô trống đầu tháng
                    for (let j = 0; j < startingDay; j++) {
                        const emptyCell = document.createElement('div');
                        emptyCell.className = 'month-day';
                        daysGridDiv.appendChild(emptyCell);
                    }

                    // Thêm ô ngày có màu
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayCell = document.createElement('div');
                        const activityLevel = Math.floor(Math.random() * 5); // Random 0-4
                        dayCell.className = `month-day activity-${activityLevel}`; // <<< GÁN LỚP activity-*
                        dayCell.title = `${day}/${month + 1}/${year} - Mức ${activityLevel}`;
                        // console.log(`Day ${day}: Level ${activityLevel}, Class: ${dayCell.className}`); // Log chi tiết từng ô (có thể bật nếu cần debug sâu)
                        daysGridDiv.appendChild(dayCell);
                    }

                    monthDiv.appendChild(daysGridDiv); // Thêm lưới ngày vào div tháng
                    container.appendChild(monthDiv); // Thêm div tháng vào container chính
                });
                console.log("Monthly heatmaps generation complete."); // Log kết thúc
            }
            // Đảm bảo container tồn tại trước khi gọi hàm
            if (document.getElementById('monthlyActivitySection')) {
                 generateMonthlyHeatmaps('monthlyActivitySection', 4);
            } else {
                 console.error("Container #monthlyActivitySection not found! Cannot generate monthly heatmaps.");
            }


            // Gắn sự kiện cho nút Share Achievements bằng ID
            const shareBtn = document.getElementById('shareAchievementsBtn');
            if (shareBtn) {
                shareBtn.addEventListener('click', shareAchievements);
                console.log("Event listener added to shareAchievementsBtn");
            } else {
                console.error("Could not find shareAchievementsBtn!");
            }

        });
    </script>
</body>
</html>