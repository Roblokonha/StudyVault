<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <title>StudyVault - Dashboard</title>
    <style>
        /* --- Phong c√°ch chung --- */
        :root {
             --primary-blue: #0d6efd; --light-bg: #f8f9fa; --white-bg: #ffffff; --card-border-radius: 0.75rem; --element-border-radius: 0.5rem; --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); --text-dark: #212529; --text-muted: #6c757d; --accent-red: #dc3545; --bs-info: #0dcaf0; --bs-info-subtle: #cff4fc; --bs-info-text-emphasis: #055160; --bs-warning: #ffc107; --bs-success: #198754; --bs-danger: #dc3545; --bs-purple: #6f42c1;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--light-bg); color: var(--text-dark); position: relative; min-height: 100vh; padding-bottom: 80px; }
        .navbar { background-color: var(--white-bg) !important; box-shadow: var(--card-shadow); }
        .navbar-brand { color: var(--text-dark) !important; font-weight: 600; }
        .navbar-brand i { color: var(--primary-blue); }
        .nav-link { color: #495057 !important; font-weight: 500; }
        .nav-link.active { color: var(--primary-blue) !important; font-weight: 600;}
        .card { border-radius: var(--card-border-radius); border: none; box-shadow: var(--card-shadow); margin-bottom: 1.5rem; background-color: var(--white-bg); border-top: 4px solid var(--primary-blue); }
        .card-header { background-color: transparent; border-bottom: 1px solid #f1f3f5; font-weight: 600; padding: 1rem 1.25rem; color: var(--primary-blue); }
        .card-header i { color: var(--primary-blue) !important; }
        .btn { border-radius: var(--element-border-radius); padding: 0.5rem 1rem; font-weight: 500; }
        .btn-primary { background-color: var(--primary-blue); border-color: var(--primary-blue); }
        .btn-primary:hover { background-color: #0b5ed7; border-color: #0a58ca; }
        .btn-danger { background-color: var(--accent-red); border-color: var(--accent-red); }
        .btn-danger:hover { background-color: #c82333; border-color: #bd2130; }
        .btn-outline-secondary { border-color: #ced4da; color: #495057;}
        .btn-outline-secondary:hover { background-color: #e9ecef; color: #343a40;}
        .btn-outline-danger { border-color: var(--accent-red); color: var(--accent-red); }
        .btn-outline-danger:hover { background-color: var(--accent-red); color: white; }
        .btn-outline-primary { border-color: var(--primary-blue); color: var(--primary-blue);}
        .btn-outline-primary:hover { background-color: var(--primary-blue); color: white;}
        .btn-outline-info { border-color: #0dcaf0; color: #0dcaf0;}
        .btn-outline-info:hover { background-color: #0dcaf0; color: white;}
        .btn-outline-success { border-color: #198754; color: #198754;}
        .btn-outline-success:hover { background-color: #198754; color: white;}
        .form-control, .form-select { border-radius: var(--element-border-radius); border-color: #dee2e6; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-blue); box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .badge { border-radius: 50px; font-weight: 500; padding: 0.35em 0.65em; }
        h1 { margin-bottom: 1.5rem !important; font-weight: 600; color: var(--primary-blue); }
        h3 { margin-bottom: 1.5rem !important; font-weight: 600; }
        .table { border: none; margin-bottom: 0; }
        .table thead th { background-color: var(--light-bg); border-bottom: 2px solid #dee2e6; font-weight: 600; color: var(--text-dark); text-transform: uppercase; font-size: 0.8em; padding-top: 0.75rem; padding-bottom: 0.75rem; text-align: center; }
        .table tbody td { vertical-align: middle; padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .table tbody tr { border-color: #f1f3f5; }
        .table tbody tr:last-child td { border-bottom: none; }
        .table tbody tr:hover { background-color: #f8f9fa; }
        .action-btn { margin: 0 2px; padding: 0.3rem 0.5rem; font-size: 0.85rem; }
        .doc-icon { margin-right: 8px; vertical-align: -0.1em; font-size: 1.1em;}
        .keywords-list { font-size: 0.85em; color: var(--text-muted); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; vertical-align: middle;}
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; background-color: #adb5bd; }
        .status-dot.dot-read { background-color: #198754; }
        .status-dot.dot-unread { background-color: #ffc107; }
        .pagination .page-link { border-radius: var(--element-border-radius); margin: 0 3px; border-color: #dee2e6;}
        .pagination .page-item.active .page-link { background-color: var(--primary-blue); border-color: var(--primary-blue);}
        .suggestion-card-body { font-size: 0.9rem; }
        .suggestion-card-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem;}
        .suggestion-card-text { margin-bottom: 0.5rem; }
        .suggestion-card-footer { font-size: 0.8rem; padding-top: 0.75rem; border-top: 1px solid #eee; margin-top: 1rem;}
        #focusLockBtn { position: fixed; bottom: 20px; right: 20px; z-index: 1050; background-color: var(--primary-blue) !important; border-color: var(--primary-blue) !important; color: white !important; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        #focusLockModal .form-label { font-weight: 500; }
        #focusLockModal .modal-content { border-radius: var(--card-border-radius); border-top: 4px solid var(--primary-blue); }
        #focusFeedback { margin-top: 1rem; font-weight: 500;}
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="StudyVault Logo" height="30" class="d-inline-block align-text-top me-2">
                StudyVault
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link active" aria-current="page" href="{{ url_for('index') }}">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('upload_file') }}">T·∫£i l√™n</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('study_timeline') }}">Timeline</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('lazy_market') }}">Chia s·∫ª t√†i li·ªáu & BXH</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category if category in ['success', 'danger', 'warning', 'info'] else 'info' }} alert-dismissible fade show rounded-pill" role="alert">
                    {{ message }} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        <div class="card mb-4 border-info">
            <div class="card-header bg-info-subtle text-info-emphasis">
               <i class="bi bi-stars me-2"></i> T√†i li·ªáu C·ªông ƒë·ªìng Hot Nh·∫•t (Demo)
            </div>
            <div class="card-body">
                <div class="d-flex flex-nowrap overflow-auto pb-2" style="gap: 1rem;">
                    <div class="card flex-shrink-0" style="width: 18rem; border-top-color: var(--bs-warning);">
                        <div class="card-body small">
                            <h6 class="card-title text-truncate"><i class="bi bi-file-earmark-pdf text-danger me-1"></i>T·ªïng h·ª£p ƒê·ªÅ thi Kinh t·∫ø Vƒ© m√¥</h6>
                            <p class="card-text text-muted mb-1">Danh m·ª•c: Kinh t·∫ø h·ªçc</p>
                            <p class="card-text mb-1">
                                <i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-half text-warning"></i><span class="ms-1 small">(4.6)</span>
                            </p>
                            <a href="#" class="btn btn-sm btn-outline-primary mt-1" onclick="return false;">Xem chi ti·∫øt (Demo)</a>
                        </div>
                    </div>
                    <div class="card flex-shrink-0" style="width: 18rem; border-top-color: var(--bs-success);">
                         <div class="card-body small">
                            <h6 class="card-title text-truncate"><i class="bi bi-filetype-py text-primary me-1"></i>Gi·∫£i thu·∫≠t Quy ho·∫°ch ƒë·ªông c∆° b·∫£n</h6>
                            <p class="card-text text-muted mb-1">Danh m·ª•c: L·∫≠p tr√¨nh</p>
                            <p class="card-text mb-1">
                                <i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star text-warning"></i><span class="ms-1 small">(4.1)</span>
                            </p>
                            <a href="#" class="btn btn-sm btn-outline-primary mt-1" onclick="return false;">Xem chi ti·∫øt (Demo)</a>
                        </div>
                    </div>
                     <div class="card flex-shrink-0" style="width: 18rem; border-top-color: var(--bs-danger);">
                        <div class="card-body small">
                            <h6 class="card-title text-truncate"><i class="bi bi-file-earmark-word text-primary me-1"></i>T·ª´ v·ª±ng IELTS Band 8+</h6>
                            <p class="card-text text-muted mb-1">Danh m·ª•c: Ngo·∫°i ng·ªØ</p>
                             <p class="card-text mb-1">
                                <i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><span class="ms-1 small">(4.9)</span>
                            </p>
                            <a href="#" class="btn btn-sm btn-outline-primary mt-1" onclick="return false;">Xem chi ti·∫øt (Demo)</a>
                        </div>
                    </div>
                     <div class="card flex-shrink-0" style="width: 18rem; border-top-color: var(--bs-purple);">
                        <div class="card-body small">
                            <h6 class="card-title text-truncate"><i class="bi bi-calculator text-success me-1"></i>C√¥ng th·ª©c T√≠ch ph√¢n c∆° b·∫£n</h6>
                            <p class="card-text text-muted mb-1">Danh m·ª•c: To√°n h·ªçc</p>
                             <p class="card-text mb-1">
                                <i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-fill text-warning"></i><i class="bi bi-star-half text-warning"></i><span class="ms-1 small">(4.7)</span>
                            </p>
                            <a href="#" class="btn btn-sm btn-outline-primary mt-1" onclick="return false;">Xem chi ti·∫øt (Demo)</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% if suggested_docs %}
         <div class="card mb-4">
             <div class="card-header"><i class="bi bi-lightbulb-fill text-warning"></i> G·ª£i √Ω cho b·∫°n</div>
             <div class="card-body suggestion-card-body">
                 <div class="row">
                     {% for sugg_doc in suggested_docs %}
                     <div class="col-lg-4 col-md-6 mb-3">
                         <div class="card h-100 border-0 shadow-sm">
                             <div class="card-body d-flex flex-column">
                                 <h6 class="card-title suggestion-card-title">
                                     {% set sugg_icon = 'bi-file-earmark' %}
                                     {% if sugg_doc.doc_type == 'pdf' %}{% set sugg_icon = 'bi-file-earmark-pdf text-danger' %}
                                     {% elif sugg_doc.doc_type == 'link' %}{% set sugg_icon = 'bi-link-45deg text-primary' %}
                                     {% elif sugg_doc.doc_type == 'image' %}{% set sugg_icon = 'bi-image text-success' %}
                                     {% elif sugg_doc.doc_type == 'video' %}{% set sugg_icon = 'bi-film text-warning' %}
                                     {% elif sugg_doc.doc_type == 'googledrive_link' %}{% set sugg_icon = 'bi-google text-info' %}
                                     {% elif sugg_doc.doc_type == 'docx' %}{% set sugg_icon = 'bi-file-earmark-word text-primary' %}
                                     {% elif sugg_doc.doc_type == 'txt' %}{% set sugg_icon = 'bi-file-earmark-text text-secondary' %}
                                     {% endif %}
                                     <i class="bi {{ sugg_icon }} doc-icon" title="{{ sugg_doc.doc_type | capitalize }}"></i>
                                     {{ sugg_doc.filename | truncate(40) }}
                                 </h6>
                                 <p class="card-text suggestion-card-text"><span class="badge bg-secondary rounded-pill">{{ sugg_doc.category }}</span></p>
                                 {% set suggestion_reason = 'Ch∆∞a ƒë·ªçc' if not sugg_doc.last_viewed_date else ('Thi·∫øu th√¥ng tin' if not sugg_doc.engagement_level or not sugg_doc.context_event else 'Xem l·∫°i') %}
                                 {% set badge_color = 'bg-warning text-dark' if suggestion_reason == 'Ch∆∞a ƒë·ªçc' else ('bg-info text-dark' if suggestion_reason == 'Thi·∫øu th√¥ng tin' else 'bg-light text-dark') %}
                                 <div class="mt-auto suggestion-card-footer d-flex justify-content-between align-items-center">
                                     <span class="badge {{ badge_color }} rounded-pill">{{ suggestion_reason }}</span>
                                     <div>
                                         <a href="{{ url_for('view_document', document_id=sugg_doc.id) }}" class="btn btn-sm btn-outline-primary action-btn" title="Xem & B·ªï sung th√¥ng tin"><i class="bi bi-eye-fill"></i> Xem</a>
                                         <a href="{{ url_for('lazy_market', suggest_job='summary', doc_id=sugg_doc.id) }}" class="btn btn-sm btn-outline-info action-btn" title="M√¥ ph·ªèng g·ª≠i job t√≥m t·∫Øt"><i class="bi bi-send-check-fill"></i> Job?</a>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                     {% endfor %}
                 </div>
             </div>
         </div>
         {% endif %}
        <h1 class="mb-3"><i class="bi bi-collection-fill"></i> T·∫•t c·∫£ T√†i li·ªáu</h1>

        <div class="row mb-4">
            <div class="col-md-6 mb-2 mb-md-0">
                <form method="GET" action="{{ url_for('index') }}">
                    <div class="input-group">
                        <span class="input-group-text bg-white"><i class="bi bi-search text-primary"></i></span>
                        <input type="text" class="form-control" placeholder="T√¨m theo t√™n file ho·∫∑c keyword..." name="search_query" value="{{ search_query or '' }}">
                        {% if category_filter %} <input type="hidden" name="category" value="{{ category_filter }}"> {% endif %}
                         {% if search_query or category_filter %}
                           <a href="{{ url_for('index') }}" class="btn btn-outline-secondary" style="border-radius: 0 var(--element-border-radius) var(--element-border-radius) 0;" title="X√≥a b·ªô l·ªçc/t√¨m ki·∫øm">&times;</a>
                         {% endif %}
                    </div>
                </form>
            </div>
            <div class="col-md-6">
                 <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button" id="categoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-filter-left me-1"></i> {{ 'L·ªçc: ' + category_filter if category_filter else 'L·ªçc theo Danh m·ª•c' }}
                    </button>
                    <ul class="dropdown-menu w-100" aria-labelledby="categoryDropdown">
                        <li><a class="dropdown-item {% if not category_filter %}active{% endif %}" href="{{ url_for('index', search_query=search_query) }}">-- T·∫•t c·∫£ --</a></li>
                        {% for cat in categories %}
                        <li><a class="dropdown-item {% if category_filter == cat %}active{% endif %}" href="{{ url_for('index', category=cat, search_query=search_query) }}">{{ cat }}</a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="table-responsive">
                 <table class="table table-hover align-middle">
                    <thead>
                       <tr>
                            <th scope="col">#</th>
                            <th scope="col">T√™n file / Link</th>
                            <th scope="col">Danh m·ª•c</th>
                            <th scope="col">Tr·∫°ng th√°i</th>
                            <th scope="col">Keywords</th>
                            <th scope="col">Ng√†y t·∫£i</th>
                            <th scope="col">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doc in documents %}
                        <tr>
                            <td class="text-center text-muted">{{ pagination.per_page * (pagination.page - 1) + loop.index }}</td>
                            <td>
                                 {% set icon_class = 'bi-file-earmark' %}
                                 {% if doc.doc_type == 'pdf' %}{% set icon_class = 'bi-file-earmark-pdf text-danger' %}
                                 {% elif doc.doc_type == 'link' %}{% set icon_class = 'bi-link-45deg text-primary' %}
                                 {% elif doc.doc_type == 'image' %}{% set icon_class = 'bi-image text-success' %}
                                 {% elif doc.doc_type == 'video' %}{% set icon_class = 'bi-film text-warning' %}
                                 {% elif doc.doc_type == 'googledrive_link' %}{% set icon_class = 'bi-google text-info' %}
                                 {% elif doc.doc_type == 'docx' %}{% set icon_class = 'bi-file-earmark-word text-primary' %}
                                 {% elif doc.doc_type == 'txt' %}{% set icon_class = 'bi-file-earmark-text text-secondary' %}
                                 {% endif %}
                                 <i class="bi {{ icon_class }} doc-icon" title="{{ doc.doc_type | capitalize }}"></i>
                                <a href="{{ url_for('view_document', document_id=doc.id) }}" class="text-decoration-none fw-medium" title="{{ doc.filename }}"> {% if doc.doc_type in ['link', 'googledrive_link'] %}
                                        {{ doc.filepath | truncate(50) }}
                                    {% else %}
                                        {{ doc.filename | truncate(50) }}
                                    {% endif %}
                                </a>
                            </td>
                            <td class="text-center"><span class="badge bg-info-subtle text-info-emphasis border border-info-subtle rounded-pill">{{ doc.category | default('N/A', true) }}</span></td>
                            <td class="text-center">
                                <span class="status-dot {{ 'dot-read' if doc.last_viewed_date else 'dot-unread' }}" title="{{ 'ƒê√£ ƒë·ªçc' if doc.last_viewed_date else 'Ch∆∞a ƒë·ªçc' }}"></span>
                                <span class="small">{{ 'ƒê√£ ƒë·ªçc' if doc.last_viewed_date else 'Ch∆∞a ƒë·ªçc' }}</span>
                            </td>
                            <td>
                                {% if doc.keywords %} <span class="keywords-list" title="{{ doc.keywords }}">{{ doc.keywords }}</span>
                                {% else %} <span class="text-muted small">N/A</span> {% endif %}
                            </td>
                            <td class="text-center text-muted small">{{ doc.uploaded_date.strftime('%d/%m/%y') }}</td>
                            <td class="text-center">
                                <form method="POST" action="{{ url_for('delete_document', document_id=doc.id) }}" style="display: inline;" onsubmit="return confirm('X√≥a vƒ©nh vi·ªÖn t√†i li·ªáu n√†y?');">
                                    <button type="submit" class="btn btn-danger btn-sm action-btn" title="X√≥a"><i class="bi bi-trash"></i></button>
                                </form>
                                <button type="button"
                                        class="btn btn-outline-success btn-sm action-btn share-doc-btn"
                                        title="Chia s·∫ª l√™n BXH (Demo)"
                                        data-doc-id="{{ doc.id }}"
                                        data-doc-filename="{{ doc.filename }}"
                                        data-doc-category="{{ doc.category | default('N/A', true) }}"
                                        data-doc-type="{{ doc.doc_type }}">
                                    <i class="bi bi-share-fill"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm action-btn" title="S·ª≠a Danh m·ª•c"
                                        data-bs-toggle="modal" data-bs-target="#editCategoryModal"
                                        data-doc-id="{{ doc.id }}"
                                        data-doc-filename="{{ doc.filename }}"
                                        data-doc-category="{{ doc.category }}">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="7" class="text-center text-muted py-5">Ch∆∞a c√≥ t√†i li·ªáu n√†o. H√£y <a href="{{ url_for('upload_file') }}">t·∫£i l√™n</a>!</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% if pagination and pagination.pages > 1 %}
         <nav aria-label="Document navigation" class="mt-4 d-flex justify-content-center">
            <ul class="pagination">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}"> <a class="page-link" href="{{ url_for('index', page=pagination.prev_num, search_query=search_query, category=category_filter) if pagination.has_prev else '#' }}" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a> </li>
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %} {% if page_num %} {% if page_num == pagination.page %} <li class="page-item active" aria-current="page"><span class="page-link">{{ page_num }}</span></li> {% else %} <li class="page-item"><a class="page-link" href="{{ url_for('index', page=page_num, search_query=search_query, category=category_filter) }}">{{ page_num }}</a></li> {% endif %} {% else %} <li class="page-item disabled"><span class="page-link">...</span></li> {% endif %} {% endfor %}
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}"> <a class="page-link" href="{{ url_for('index', page=pagination.next_num, search_query=search_query, category=category_filter) if pagination.has_next else '#' }}" aria-label="Next"><span aria-hidden="true">&raquo;</span></a> </li>
            </ul>
         </nav>
         <p class="text-center text-muted small mt-2"> Trang {{ pagination.page }} / {{ pagination.pages }} (T·ªïng: {{ pagination.total }} t√†i li·ªáu) </p>
         {% elif pagination and pagination.total > 0 %}
         <p class="text-center text-muted small mt-2"> Hi·ªÉn th·ªã t·∫•t c·∫£ {{ pagination.total }} t√†i li·ªáu. </p>
         {% endif %}
        <div class="mt-4 mb-5 text-center">
            <a href="{{ url_for('upload_file') }}" class="btn btn-primary btn-lg">
                <i class="bi bi-cloud-arrow-up-fill"></i> T·∫£i l√™n t√†i li·ªáu m·ªõi
            </a>
        </div>
    </div> <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="editCategoryForm" method="POST" action="">
            <div class="modal-header"> <h5 class="modal-title" id="editCategoryModalLabel">S·ª≠a Danh m·ª•c cho T√†i li·ªáu</h5> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> </div>
            <div class="modal-body"> <p>T√†i li·ªáu: <strong id="modal-doc-filename"></strong></p> <div class="mb-3"> <label for="edit-category-select" class="form-label">Ch·ªçn danh m·ª•c m·ªõi:</label> <select class="form-select" id="edit-category-select" name="new_category" required> {% set all_cats = categories + ([default_category] if default_category not in categories else []) %} {% for cat in all_cats | sort %} <option value="{{ cat }}">{{ cat }}</option> {% endfor %} </select> </div> </div>
            <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button> <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button> </div>
          </form>
        </div>
      </div>
    </div>

    <button type="button" class="btn btn-primary" id="focusLockBtn" title="K√≠ch ho·∫°t Ch·∫ø ƒë·ªô T·∫≠p trung (Th·ªß c√¥ng)">
        <i class="bi bi-joystick"></i>
    </button>

    <div class="modal fade" id="focusLockModal" tabindex="-1" aria-labelledby="focusLockModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="focusLockModalLabel"><i class="bi bi-unlock-fill text-primary"></i> M·ªü kh√≥a ·ª®ng d·ª•ng (M√¥ ph·ªèng)</h5>
          </div>
          <div class="modal-body">
            <p class="text-muted small" id="focusLockIntroText">ƒê·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng ·ª©ng d·ª•ng kh√°c (v√≠ d·ª•: Facebook, Youtube - M√¥ ph·ªèng), b·∫°n c·∫ßn tr·∫£ l·ªùi ƒë√∫ng c√°c c√¢u h·ªèi √¥n t·∫≠p ki·∫øn th·ª©c ƒë√£ h·ªçc:</p>
            <div id="focusLockMascot" class="text-center my-3" style="display: none;">
                <span id="mascotIcon" style="font-size: 2rem;">üòº</span>
                <p id="mascotMessage" class="small text-muted fst-italic mt-1"></p>
            </div>
            <div class="mb-3">
                <label for="focusQuestion" class="form-label">C√¢u h·ªèi:</label>
                <p id="focusQuestion" class="fw-bold fs-5"></p>
                <small class="text-muted" id="focusQuestionCategory"></small>
            </div>
            <div class="mb-3">
                <label for="focusAnswerInput" class="form-label">C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</label>
                <textarea class="form-control" id="focusAnswerInput" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi..." rows="3"></textarea>
            </div>
            <div id="focusFeedback" class="mt-2"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="button" class="btn btn-primary" id="checkFocusAnswerBtn">Ki·ªÉm tra</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Script Modal S·ª≠a Danh m·ª•c ---
        var editModalEl = document.getElementById('editCategoryModal');
        if (editModalEl) {
            editModalEl.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var docId = button.getAttribute('data-doc-id');
                var docFilename = button.getAttribute('data-doc-filename');
                var currentCategory = button.getAttribute('data-doc-category');
                var modalFilenameEl = editModalEl.querySelector('#modal-doc-filename');
                var categorySelectEl = editModalEl.querySelector('#edit-category-select');
                var formEl = editModalEl.querySelector('#editCategoryForm');
                if(modalFilenameEl) modalFilenameEl.textContent = docFilename;
                if(categorySelectEl) {
                    let categoryExists = false;
                    for(let i=0; i < categorySelectEl.options.length; i++) {
                        if (categorySelectEl.options[i].value === currentCategory) {
                            categoryExists = true; break;
                        }
                    }
                    categorySelectEl.value = categoryExists ? currentCategory : (categorySelectEl.options[0] ? categorySelectEl.options[0].value : '');
                 }
                if(formEl) formEl.action = '/edit_category/' + docId;
            });
        }

        // --- Script cho Focus Lock ---
        const focusLockBtn = document.getElementById('focusLockBtn');
        const focusLockModalEl = document.getElementById('focusLockModal');
        const focusQuestionEl = document.getElementById('focusQuestion');
        const focusQuestionCategoryEl = document.getElementById('focusQuestionCategory');
        const focusAnswerInput = document.getElementById('focusAnswerInput');
        const checkFocusAnswerBtn = document.getElementById('checkFocusAnswerBtn');
        const focusFeedbackEl = document.getElementById('focusFeedback');
        const focusLockMascotEl = document.getElementById('focusLockMascot');
        const mascotIconEl = document.getElementById('mascotIcon');
        const mascotMessageEl = document.getElementById('mascotMessage');
        const focusLockModalLabel = document.getElementById('focusLockModalLabel');
        const focusLockIntroTextEl = document.getElementById('focusLockIntroText');

        let questionsBatch = [];
        let currentQuestionIndex = 0;
        let questionsCorrect = 0;
        let failedAttemptsInSession = 0;
        const MIN_CORRECT_TO_UNLOCK = 2; 

        let focusModal = null;
        if (focusLockModalEl) {
            focusModal = new bootstrap.Modal(focusLockModalEl);
        }

        // --- Logic cho Idle Timer ---
        let idleTimer = null;
        const IDLE_TIMEOUT = 3 * 60 * 1000;

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            if (focusLockModalEl && !focusLockModalEl.classList.contains('show')) {
                 idleTimer = setTimeout(triggerFocusLockOnIdle, IDLE_TIMEOUT);
            }
        }

        function triggerFocusLockOnIdle() {
            const anyOtherModalOpen = document.querySelector('.modal.show:not(#focusLockModal)');
            if (focusLockModalEl && !focusLockModalEl.classList.contains('show') && !anyOtherModalOpen) {
                if(focusLockIntroTextEl) focusLockIntroTextEl.textContent = "C√≥ v·∫ª b·∫°n ƒëang ngh·ªâ ng∆°i? H√£y tr·∫£ l·ªùi v√†i c√¢u h·ªèi ƒë·ªÉ c·ªßng c·ªë ki·∫øn th·ª©c nh√©!";
                displayMascotMessage('ü§î', 'L√¢u r·ªìi kh√¥ng th·∫•y b·∫°n ho·∫°t ƒë·ªông. L√†m v√†i c√¢u h·ªèi √¥n t·∫≠p cho vui nh√©!', 'info');
                startFocusLockSession(true); 
                focusModal.show();
            } else {
                resetIdleTimer();
            }
        }
        
        function checkAnswerSimilarity(userAnswer, correctAnswer) {
            if (!userAnswer || !correctAnswer) return false;
            const normalize = (str) => str.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replace(/\s{2,}/g," ");
            const ua = normalize(userAnswer);
            const ca = normalize(correctAnswer);
            const correctWords = new Set(ca.split(' ').filter(w => w.length > 1));
            const userWords = new Set(ua.split(' '));
            if (correctWords.size === 0) return ua === ca;
            let matchCount = 0;
            for (const word of userWords) {
                if (correctWords.has(word)) {
                    matchCount++;
                }
            }
            const similarity = matchCount / correctWords.size;
            console.log(`Answer similarity: ${similarity.toFixed(2)}`);
            return similarity > 0.7;
        }

        function updateModalTitle() {
            if (questionsBatch.length > 0 && currentQuestionIndex < questionsBatch.length) {
                focusLockModalLabel.innerHTML = `<i class="bi bi-unlock-fill text-primary"></i> M·ªü kh√≥a (C√¢u ${currentQuestionIndex + 1}/${questionsBatch.length})`;
            } else if (questionsBatch.length > 0 && currentQuestionIndex >= questionsBatch.length) {
                focusLockModalLabel.innerHTML = `<i class="bi bi-unlock-fill text-primary"></i> K·∫øt qu·∫£ M·ªü kh√≥a`;
            } else {
                focusLockModalLabel.innerHTML = `<i class="bi bi-unlock-fill text-primary"></i> M·ªü kh√≥a ·ª®ng d·ª•ng (M√¥ ph·ªèng)`;
            }
        }

        function displayCurrentQuestion() {
            if (currentQuestionIndex < questionsBatch.length) {
                const questionData = questionsBatch[currentQuestionIndex];
                focusQuestionEl.textContent = questionData.q || "L·ªói: Kh√¥ng c√≥ n·ªôi dung c√¢u h·ªèi.";
                focusQuestionCategoryEl.textContent = `(Lƒ©nh v·ª±c: ${questionData.cat || 'Chung'})`;
                focusAnswerInput.value = '';
                focusFeedbackEl.innerHTML = '';
                focusFeedbackEl.className = 'mt-2';
                focusAnswerInput.disabled = false;
                checkFocusAnswerBtn.disabled = false;
                checkFocusAnswerBtn.textContent = 'Ki·ªÉm tra';
                updateModalTitle();
            } else {
                handleSessionEnd();
            }
        }

        async function startFocusLockSession(isAutoTriggered = false) {
            focusQuestionEl.textContent = 'ƒêang t·∫£i b·ªô c√¢u h·ªèi...';
            focusQuestionCategoryEl.textContent = '';
            focusAnswerInput.value = '';
            focusAnswerInput.disabled = true;
            checkFocusAnswerBtn.disabled = true;
            focusFeedbackEl.innerHTML = '';
            focusFeedbackEl.className = 'mt-2';
            
            if (!isAutoTriggered) {
                if (focusLockMascotEl) focusLockMascotEl.style.display = 'none';
                if(focusLockIntroTextEl) focusLockIntroTextEl.textContent = "ƒê·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng ·ª©ng d·ª•ng kh√°c, b·∫°n c·∫ßn tr·∫£ l·ªùi ƒë√∫ng c√°c c√¢u h·ªèi √¥n t·∫≠p ki·∫øn th·ª©c ƒë√£ h·ªçc:";
            }
            
            questionsBatch = [];
            currentQuestionIndex = 0;
            questionsCorrect = 0;
            failedAttemptsInSession = 0;
            updateModalTitle();

            try {
                const response = await fetch('/get_recall_data');
                const data = await response.json();

                if (!response.ok || !Array.isArray(data) || data.length === 0) {
                     throw new Error(data.error || "Kh√¥ng th·ªÉ t·∫£i b·ªô c√¢u h·ªèi.");
                }

                if (data[0].type === 'error') {
                     focusQuestionEl.textContent = data[0].q;
                     focusQuestionCategoryEl.textContent = `(Lƒ©nh v·ª±c: ${data[0].cat || 'H·ªá th·ªëng'})`;
                     displayMascotMessage('üòø', 'Hmm, hi·ªán t·∫°i kh√¥ng c√≥ c√¢u h·ªèi n√†o c·∫£. B·∫°n th·ª≠ t·∫£i th√™m t√†i li·ªáu ho·∫∑c t√≥m t·∫Øt nh√©!', 'info');
                     questionsBatch = [];
                     return; 
                }
                questionsBatch = data;
                displayCurrentQuestion(); 
                displayMascotMessage('üòº', `B·∫Øt ƒë·∫ßu th·ª≠ th√°ch v·ªõi ${questionsBatch.length} c√¢u h·ªèi n√†o!`);
                
            } catch (error) {
                console.error("L·ªói khi l·∫•y b·ªô c√¢u h·ªèi √¥n t·∫≠p:", error);
                focusQuestionEl.textContent = error.message;
                displayMascotMessage('üôÄ', 'H·ªá th·ªëng g·∫∑p tr·ª•c tr·∫∑c khi t·∫£i c√¢u h·ªèi!');
            }
        }

        function displayMascotMessage(icon, message, type = 'info') {
            if (!focusLockMascotEl || !mascotIconEl || !mascotMessageEl) return;
            mascotIconEl.textContent = icon;
            mascotMessageEl.textContent = message;
            focusLockMascotEl.style.display = 'block';

            mascotMessageEl.className = 'small fst-italic mt-1 ';
            if (type === 'warning') mascotMessageEl.classList.add('text-danger');
            else if (type === 'success') mascotMessageEl.classList.add('text-success');
            else mascotMessageEl.classList.add('text-muted');
        }

        function handleSessionEnd() {
            focusAnswerInput.disabled = true;
            checkFocusAnswerBtn.disabled = true;
            checkFocusAnswerBtn.textContent = 'Ho√†n th√†nh';
            updateModalTitle(); 
            const totalAttempted = questionsBatch.length;

            if (totalAttempted === 0) {
                 focusFeedbackEl.innerHTML = `<div class="alert alert-info">Kh√¥ng c√≥ c√¢u h·ªèi n√†o ƒë·ªÉ ho√†n th√†nh phi√™n n√†y.</div>`;
                 displayMascotMessage('ü§î', 'Kh√¥ng c√≥ th·ª≠ th√°ch n√†o l√∫c n√†y c·∫£!', 'info');
                 setTimeout(() => { if (focusModal) focusModal.hide(); }, 3000);
                 return;
            }

            if (questionsCorrect >= MIN_CORRECT_TO_UNLOCK) {
                focusFeedbackEl.innerHTML = `<div class="alert alert-success">Tuy·ªát v·ªùi! B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${questionsCorrect}/${totalAttempted} c√¢u. M·ªü kh√≥a th√†nh c√¥ng!</div>`;
                displayMascotMessage('üéâ', `Xu·∫•t s·∫Øc! B·∫°n ƒë√£ chinh ph·ª•c ƒë∆∞·ª£c th·ª≠ th√°ch! M·ªü kh√≥a th√¥i!`, 'success');
                setTimeout(() => { if (focusModal) focusModal.hide(); }, 2500);
            } else {
                focusFeedbackEl.innerHTML = `<div class="alert alert-warning">B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${questionsCorrect}/${totalAttempted} c√¢u. C·∫ßn √≠t nh·∫•t ${MIN_CORRECT_TO_UNLOCK} c√¢u ƒë√∫ng ƒë·ªÉ m·ªü kh√≥a. H√£y c·ªë g·∫Øng h∆°n!</div>`;
                displayMascotMessage('üòø', `Ch∆∞a ƒë·ªß s·ªë c√¢u ƒë√∫ng r·ªìi. ƒê·ª´ng n·∫£n, l·∫ßn sau s·∫Ω t·ªët h∆°n nh√©!`, 'warning');
                setTimeout(() => { if (focusModal) focusModal.hide(); }, 4000);
            }
        }

        if (focusLockBtn && focusModal) {
            focusLockBtn.addEventListener('click', function() {
                startFocusLockSession(false); 
                focusModal.show();
            });
        }

        if (checkFocusAnswerBtn) {
            checkFocusAnswerBtn.addEventListener('click', function() {
                if (currentQuestionIndex >= questionsBatch.length) return;
                const questionData = questionsBatch[currentQuestionIndex];
                const userAnswer = focusAnswerInput.value;
                const correctAnswer = questionData.a || "";
                
                let isCorrect = checkAnswerSimilarity(userAnswer, correctAnswer);

                if (isCorrect) {
                    questionsCorrect++;
                    focusFeedbackEl.innerHTML = '<div class="alert alert-success p-1 small">Ch√≠nh x√°c!</div>';
                    displayMascotMessage('üòª', 'ƒê√∫ng r·ªìi! Gi·ªèi qu√° ƒëi!', 'success');
                } else {
                    failedAttemptsInSession++;
                    focusFeedbackEl.innerHTML = `<div class="alert alert-danger p-1 small">Sai r·ªìi. ƒê√°p √°n ƒë√∫ng l√†: "<strong>${correctAnswer}</strong>"</div>`;
                    displayMascotMessage('üòø', 'Hmm, c√≥ v·∫ª b·∫°n c·∫ßn xem l·∫°i b√†i n√†y m·ªôt ch√∫t r·ªìi!', 'warning');
                }
                
                currentQuestionIndex++;
                focusAnswerInput.disabled = true;
                checkFocusAnswerBtn.disabled = true;
                
                setTimeout(() => {
                    displayCurrentQuestion();
                }, 2500);
            });
        }

        if (focusLockModalEl) {
            focusLockModalEl.addEventListener('hide.bs.modal', function (event) {
                resetIdleTimer();
            });
            focusLockModalEl.addEventListener('hidden.bs.modal', function () {
                questionsBatch = [];
                currentQuestionIndex = 0;
                questionsCorrect = 0;
                failedAttemptsInSession = 0;
                if(focusLockIntroTextEl) focusLockIntroTextEl.textContent = "ƒê·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng ·ª©ng d·ª•ng kh√°c, b·∫°n c·∫ßn tr·∫£ l·ªùi ƒë√∫ng c√°c c√¢u h·ªèi √¥n t·∫≠p ki·∫øn th·ª©c ƒë√£ h·ªçc:";
                updateModalTitle();
                resetIdleTimer(); 
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            ['mousemove', 'mousedown', 'keydown', 'scroll', 'touchstart'].forEach(function(eventName) {
                document.addEventListener(eventName, resetIdleTimer, false);
            });
            resetIdleTimer(); 
        });

        // --- Script cho N√∫t Share (d√πng localStorage) ---
        document.addEventListener('click', function(event) {
            const shareButton = event.target.closest('.share-doc-btn');
            if (shareButton) {
                event.preventDefault();
                const docData = { id: shareButton.dataset.docId, name: shareButton.dataset.docFilename, category: shareButton.dataset.docCategory, doc_type: shareButton.dataset.docType };
                try {
                    localStorage.setItem('sharedDocForRanking', JSON.stringify(docData));
                    window.location.href = "{{ url_for('lazy_market') }}#ranking-tab";
                } catch (e) {
                    console.error("L·ªói khi l∆∞u v√†o localStorage:", e);
                }
            }
        });
    </script>
</body>
</html>